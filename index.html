<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/30/hello-world/" class="article-date">
  <time datetime="2016-12-30T08:15:30.984Z" itemprop="datePublished">2016-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/30/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/30/hello-world/" data-id="cixbj6t3y0000pctfjz30h05c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-主题切换实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/23/主题切换实现/" class="article-date">
  <time datetime="2016-12-23T04:51:29.073Z" itemprop="datePublished">2016-12-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/主题切换/">主题切换</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/23/主题切换实现/">Android主题切换实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>如何通过Android提供的API实现夜间主题切换</p>
</blockquote>
<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">AppCompatDelegate.setDefaultNightMode([AppCompatDelegate.MODE_NIGHT_NO]);</div></pre></td></tr></table></figure>
<ul>
<li>MODE_NIGHT_NO 日间模式</li>
</ul>
<ul>
<li>MODE_NIGHT_YES 夜间模式</li>
</ul>
<ul>
<li>MODE_NIGHT_AUTO 根据时间自动切换日夜间模式</li>
</ul>
<ul>
<li>MODE_NIGHT_FOLLOW_SYSTEM 默认模式，就是跟随系统的设置，据说有可能以后会在android系统设置中添加日夜间模式的设置，此时如果你的app是默认模式，会根据系统设置变化日夜间模式<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1></li>
</ul>
<p>只要你的activity继承AppCompatActivity，app的sdk最低版本在14以上，你在任何地方都可以调用AppCompatDelegate.setDefaultNightMode(xxx)，因为这是个静态方法，设置完之后新开启的页面，都会采用新的模式。你需要在每次切换模式之后，把当前模式保存在本地，然后在下次打开app的时候，获取当前模式并调用这个方法设置一下，就可以使app保持之前的模式。</p>
<p>接下来怎么去自定义自己的日夜间模式呢？<br>方法与之前的NightModeHelper类似，创建带-night后缀的文件夹（比如：values-night），然后添加你的资源文件，资源文件需要相同的命名（比如：colors.xml），这样就把夜间资源和日间资源关联起来了。这里注意一下，如果是drawable-xxhdpi中的资源需要夜间模式，这些夜间的资源就应该放在drawable-night-xxhdpi文件夹中。这里其实灵活性很大的，比如你可以在values-night中创建一个strings.xml，实现日夜间显示不同的文本。甚至你可以在layout-night中创建一个同样名字的布局文件，实现日夜间显示不同的布局。</p>
<p>官方为了方便开发者，在最新的v23.2.0 Support包增加了一个Theme.AppCompat.DayNight主题，如果继承这个主题，会有一些配置好的属性，如果你喜欢官方的配色，可以考虑继承这个主题，也会省下不少功夫。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/23/主题切换实现/" data-id="cixbj8xk4000l44tfrkwcgzmd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/主题/">主题</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/主题切换/">主题切换</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-模板" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/23/模板/" class="article-date">
  <time datetime="2016-12-23T04:47:07.199Z" itemprop="datePublished">2016-12-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>介绍</p>
</blockquote>
<h1 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">代码</div></pre></td></tr></table></figure>
<p>图片： <img src="/images/hander.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/23/模板/" data-id="cixbj8xk8000p44tft7soudmi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-supports-screens使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/22/supports-screens使用/" class="article-date">
  <time datetime="2016-12-22T11:18:22.513Z" itemprop="datePublished">2016-12-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/屏幕适配/">屏幕适配</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/22/supports-screens使用/">supports-screens使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文介绍<a href="https://developer.android.com/guide/topics/manifest/supports-screens-element.html" target="_blank" rel="external">Android API</a> <supports-screens> 对屏幕适配的支持</supports-screens></p>
<p>使用属性<supports-screens>元素来控制应用程序是否应分发给更小的屏幕还是有它的UI放大（“放大”），以适应更大使用系统的屏幕屏幕兼容模式。当你已经不适合更大的屏幕尺寸和正常调整大小并没有达到相应的效果，屏幕兼容模式将通过模拟扩展您的UI 正常尺寸的屏幕和中密度，然后放大，使其充满整个屏幕。要注意的是这会导致像素化和UI的模糊，因此，如果您优化的用户界面为大屏幕它的更好。 </supports-screens></p>
</blockquote>
<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;supports-screens</div><div class="line">	android:resizeable=[<span class="string">"true"</span>| <span class="string">"false"</span>]</div><div class="line">	android:smallScreens=[<span class="string">"true"</span> | <span class="string">"false"</span>]</div><div class="line">	android:normalScreens=[<span class="string">"true"</span> | <span class="string">"false"</span>]</div><div class="line">	android:largeScreens=[<span class="string">"true"</span> | <span class="string">"false"</span>]</div><div class="line">	android:xlargeScreens=[<span class="string">"true"</span> | <span class="string">"false"</span>]</div><div class="line">	android:anyDensity=[<span class="string">"true"</span> | <span class="string">"false"</span>]</div><div class="line">	android:requiresSmallestWidthDp=<span class="string">"integer"</span></div><div class="line">	android:compatibleWidthLimitDp=<span class="string">"integer"</span></div><div class="line">	android:largestWidthLimitDp=<span class="string">"integer"</span>/&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>这句话写在清单文件<manifest>标签下。</manifest></p>
</blockquote>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul>
<li><p>android:resizeable</p>
<p>  指示应用程序是否是可调整大小不同的屏幕大小。此属性是真实的，默认情况下。如果设置为false，系统将运行在您的应用程序的屏幕兼容模式在大屏幕上。</p>
<p>  此属性已被弃用。据介绍，以帮助应用过渡，从Android 1.5的到1.6时，首次引入了多屏幕的支持。你不应该使用它。</p>
</li>
<li><p>android:smallScreens</p>
<p>  指示应用程序是否支持屏幕较小的外形尺寸。一个小的屏幕被定义为一个具有较小纵横比“正常”（传统的HVGA）屏幕。不支持小屏幕的应用程序将无法使用从外部服务小屏幕设备（如谷歌播放），因为很少有这个平台可以做，使一个小屏幕上这样一个应用程序的工作。这是”true”默认。</p>
</li>
<li><p>android:normalScreens</p>
<p>  指示应用程序是否支持“正常”屏幕的外形尺寸。传统上，这是一HVGA介质密度的屏幕，但WQVGA低密度和WVGA高密度也被认为是正常的。该属性是“真”默认。</p>
</li>
<li><p>android:largeScreens</p>
<p>  指示应用程序是否支持更大的屏幕形式因素。大屏幕被定义为一个屏幕，是不是一个“正常”的手机屏幕显著较大，因此可能需要对应用程序的一部分，一些特殊的照顾好好利用它，虽然它可能依赖于系统调整，以填补屏幕。</p>
<p>  它的默认值实际上一些版本之间变化，所以它的更好，如果你明确地在任何时候宣布这个属性。若设置为“假”，将通常使屏幕兼容模式。</p>
</li>
<li><p>android:xlargeScreens</p>
<p>  指示应用程序是否支持超大屏幕的外形尺寸。一个XLARGE屏幕被定义为屏幕，比“大”屏幕显著较大，如片剂（或更大的东西），并可能需要对应用程序的一部分，特别注意利用好它，虽然它可能依靠调整该系统填补了屏幕。</p>
<p>  它的默认值实际上一些版本之间变化，所以它的更好，如果你明确地在任何时候宣布这个属性。若设置为“假”，将通常使屏幕兼容模式。</p>
<p>  此属性是在API级9出台。</p>
</li>
<li><p>android:anyDensity</p>
<p>  指示应用程序是否包括资源，以适应任何屏幕像素密度。</p>
<p>  对于支持的Android 1.6（API等级4）和更高的应用程序，这是在默认情况下“真”和你不应该设置“假”，除非你是绝对肯定的是，有必要为您的应用工作。它可能是唯一需要时间来关闭是，如果你的应用程序直接操纵位图（见支持多种屏幕以获取更多信息的文档）。</p>
</li>
<li><p>android:requiresSmallestWidthDp</p>
<p>  指定所需的最小最小宽度。的最小宽度是屏幕空间的最短尺寸（以dp必须提供给您的应用程序的用户界面，也就是说，最短可用屏幕的两个维度的单位）。因此，为了使设备被认为与应用程序兼容，该设备的smallestWidth必须大于该值等于或更大。（通常情况下，您为这个值就是“最小宽度”，你的布局支持，无论画面的当前方向。）<br>  例如，一个典型的手机屏幕上有一个最小宽度的320dp，7“平板电脑有一个600dp的最小宽度和10”平板电脑有一个720dp最小宽度。这些值通常是最小宽度，因为它们是在屏幕的可用空间的最短尺寸。</p>
<p>  这对你的价值进行比较的大小会考虑到屏幕装饰和系统界面。例如，如果该装置具有在显示器上一些持久UI元素，则系统会声明设备的smallestWidth为一个比实际屏幕尺寸小，占这些UI元素，因为这些是可提供的UI画面的像素。因此，您使用的值应该是布局所需的最小宽度，无论画面的当前方向。</p>
<p>  如果你的应用程序中正确调整大小较小的屏幕尺寸（下到 小尺寸或320dp的最小宽度），你并不需要使用这个属性。否则，你应该为这个属性相匹配的使用你的应用程序中的最小值使用的值 最小的屏幕宽度预选赛（sw<n>dp）。</n></p>
</li>
</ul>
<blockquote>
<p>注意： Android系统并没有注意这个属性，因此它不会影响你的应用程序的行为在运行时。相反，它是用来启用过滤为您的服务，如谷歌Play应用<br>程序。不过， 目前谷歌播放不支持过滤这个属性（在Android 3.2），所以你应该继续使用，如果你的应用程序不支持小屏幕的大小等属性。</p>
</blockquote>
<p>这个属性在API级别13引入的。</p>
<ul>
<li><p>android:compatibleWidthLimitDp</p>
<p>  此属性使您可以启用屏幕兼容模式通过指定您的应用程序设计的最大“最小屏幕宽度”为用户可选功能。如果设备的可用屏幕的最小边比这里你的价值越大，用户仍然可以安装应用程序，但提供给屏幕兼容模式下运行它。默认情况下，屏幕兼容模式被禁止，你的布局调整大小以适应屏幕像往常一样，但一个按钮在系统栏，使用户可以打开和关闭屏幕兼容模式下可用。</p>
<p>  如果您的应用程序与所有的屏幕尺寸兼容，其布局调整大小正确，你不需要使用这个属性。</p>
</li>
</ul>
<blockquote>
<p>注：目前，屏幕兼容模式只模拟手机屏幕有320dp宽度，因此，如果您的值不应用于屏幕兼容模式android:compatibleWidthLimitDp比320大。</p>
</blockquote>
<p>这个属性在API级别13引入的。</p>
<ul>
<li><p>android:largestWidthLimitDp</p>
<p>  该属性可以强制启用屏幕兼容模式通过指定您的应用程序设计的最大“最小屏幕宽度”。如果设备的可用屏幕的最小侧比你更大的价值在这里，应用程序屏幕兼容模式运行，没有办法为用户禁用它。<br>  如果您的应用程序与所有的屏幕尺寸兼容，其布局调整大小正确，你不需要使用这个属性。否则，你应该首先考虑使用android:compatibleWidthLimitDp属性。您应该使用 android:largestWidthLimitDp，只有当调整为更大的屏幕和屏幕兼容模式时，用户应该使用你的应用程序的唯一方法您的应用程序在功能上打破属性。</p>
</li>
</ul>
<blockquote>
<p>注：目前，屏幕兼容模式只模拟手机屏幕有320dp宽度，因此，如果您的值不应用于屏幕兼容模式android:largestWidthLimitDp比320大。</p>
</blockquote>
<p>这个属性在API级别13引入的。</p>
<h1 id="一般设置为"><a href="#一般设置为" class="headerlink" title="一般设置为"></a>一般设置为</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;supports-screens </div><div class="line">  android:smallScreens=<span class="string">"true"</span></div><div class="line">  android:normalScreens=<span class="string">"true"</span></div><div class="line">  android:largeScreens=<span class="string">"true"</span></div><div class="line">  android:xlargeScreens=<span class="string">"true"</span></div><div class="line">  android:anyDensity=<span class="string">"true"</span>/&gt;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/12/22/supports-screens使用/" data-id="cixbj8xk2000k44tfnlxip4tw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/supports-screens/"><supports-screens></a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android-API/">android API</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/屏幕适配/">屏幕适配</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-APP更换头像实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/29/APP更换头像实现/" class="article-date">
  <time datetime="2016-07-29T14:13:15.000Z" itemprop="datePublished">2016-07-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/更换头像/">更换头像</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/29/APP更换头像实现/">APP更换头像实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>一般开发中应用要实现用户更改头像的需求是很常见的.</p>
</blockquote>
<h3 id="一-业务逻辑"><a href="#一-业务逻辑" class="headerlink" title="一. 业务逻辑"></a>一. 业务逻辑</h3><p>步骤 : 点击头像—&gt;弹出一个对话框–&gt;通过拍照或者本地相册获取到头像图片–&gt;在本地保存一份–&gt;向服务器端发送请求–&gt;请求成功就更改本地头像,失败就不更改.—&gt;每次登陆的时候,去服务器获取头像和昵称,头像将本地头像覆盖.</p>
<h3 id="二-代码实现"><a href="#二-代码实现" class="headerlink" title="二. 代码实现"></a>二. 代码实现</h3><p>请参考我的GitHub地址<br><code>https://github.com/ChaosXusu/SelectUserPhoto/tree/master</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/29/APP更换头像实现/" data-id="cixbj8xig000044tfajydu8bz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/头像/">头像</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android性能优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/25/Android性能优化/" class="article-date">
  <time datetime="2016-07-25T12:25:38.000Z" itemprop="datePublished">2016-07-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android优化/">Android优化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/25/Android性能优化/">Android性能优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>性能优化的本质</p>
</blockquote>
<p>Android的性能优化本质是优化系统的响应时间和提高TPS(每秒处理的事务数).</p>
<blockquote>
<p>性能优化的方式</p>
</blockquote>
<ul>
<li>1.降低执行时间<ul>
<li>a.利用多线程并发或者分布式提高TPS</li>
<li>b.缓存(包括对象缓存  IO缓存  网络缓存等)</li>
<li>c. 数据结构和算法优化</li>
<li>d.性能更优的底层接口调用.如JNI实现</li>
<li>e.逻辑优化</li>
<li>f.需求优化</li>
</ul>
</li>
<li>2.同步改异步</li>
<li>3.提前或者延迟操作(错峰提高TPS)<h3 id="性能优化之布局优化"><a href="#性能优化之布局优化" class="headerlink" title="性能优化之布局优化"></a>性能优化之布局优化</h3></li>
<li>1.布局标签<ul>
<li><code>&lt;include&gt;</code>标签</li>
<li><code>&lt;viewstub&gt;</code>标签<br> <code>viewstub标签同include标签一样可以用来引入一个外部布局，不同的是，viewstub引入的布局默认不会扩张，即既不会占用显示也不会占用位置，从而在解析layout时节省cpu和内存。
viewstub常用来引入那些默认不会显示，只在特殊情况下显示的布局，如进度布局、网络失败显示的刷新布局、信息出错出现的提示布局等。</code></li>
<li><code>&lt;merge&gt;</code>标签</li>
</ul>
</li>
<li>2.去除不必要的嵌套和View节点(隐藏不展示的布局GONE)</li>
<li>3.减少不必要的inflate  <ul>
<li>ListVew缓存</li>
</ul>
</li>
<li>4.其他点<ul>
<li>用SurfaceView(不能被改变)或TextrueView(能够被改变)可以通过将绘图操作移动到另一个单独线程上提高性能</li>
<li>使用OpenGL绘制</li>
<li>尽量为所有分辨率创建资源  (减少不必要的缩放,这样会降低UI绘制速度)</li>
</ul>
</li>
<li><p>5布局调优工具</p>
<ul>
<li>hierarchy viewer</li>
</ul>
<h3 id="性能优化之布Java-Android-代码优化"><a href="#性能优化之布Java-Android-代码优化" class="headerlink" title="性能优化之布Java(Android)代码优化"></a>性能优化之布Java(Android)代码优化</h3></li>
<li>以下是网络优化中一些客户端和服务器端需要尽量遵守的准则：<ul>
<li>a. 图片必须缓存，最好根据机型做图片做图片适配</li>
<li>b. 所有http请求必须添加httptimeout</li>
<li>c. 开启gzip压缩</li>
<li>d. api接口数据以json格式返回，而不是xml或html</li>
<li>e. 根据http头信息中的Cache-Control及expires域确定是否缓存请求结果。</li>
<li>f. 确定网络请求的connection是否keep-alive</li>
<li>g. 减少网络请求次数，服务器端适当做请求合并。</li>
<li>h. 减少重定向次数</li>
<li>i. api接口服务器端响应时间不超过100ms</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/25/Android性能优化/" data-id="cixbj8xj4000444tfxuaycx0z" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/性能/">性能</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android增量更新及热修复等介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/24/Android增量更新及热修复等介绍/" class="article-date">
  <time datetime="2016-07-24T02:25:49.000Z" itemprop="datePublished">2016-07-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android更新/">Android更新</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/24/Android增量更新及热修复等介绍/">Android增量更新及热修复等介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<h3 id="概念汇总"><a href="#概念汇总" class="headerlink" title="概念汇总"></a>概念汇总</h3></blockquote>
<ul>
<li>动态加载 : 在程序运行的时候，加载一些程序自身原本不存在的可执行文件并运行这些文件里的代码逻辑。 </li>
<li>增量更新 : 做更新的时候更新差分包部分即可</li>
<li>热修复 : 修改了小部分代码,不用重新发包,悄悄的把bug修复了</li>
<li>插件化 : 拆分apk,形成宿主+寄生关系</li>
<li>组件化 : 把常用的模块代码,抽取lib工程或者jar达到复用的效果</li>
<li>multiDex:dex内方法数目超过65536（short长度范围-32768~32767),会提示错误,就需要拆分dex;</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/07/24/Android增量更新及热修复等介绍/" data-id="cixbj8xip000144tff3konsmk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/增量更新/">增量更新</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/热修复/">热修复</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/组件化/">组件化</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-图片加载框架介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/24/图片加载框架介绍/" class="article-date">
  <time datetime="2016-06-23T23:22:47.000Z" itemprop="datePublished">2016-06-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/图片加载框架/">图片加载框架</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/24/图片加载框架介绍/">Android开源项目之图片加载框架介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>作者：stormzhang<br> 链接：<a href="https://zhuanlan.zhihu.com/p/21397115" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/21397115</a><br> 来源：知乎<br> 著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote>
<h2 id="1-UniversalImageLoader"><a href="#1-UniversalImageLoader" class="headerlink" title="1. UniversalImageLoader"></a>1. UniversalImageLoader</h2><p><code>https://github.com/nostra13/Android-Universal-Image-Loader</code></p>
<p>UIL可以算是老牌最火的图片加载库了，使用过这个开源库的项目可以说是多的令人发指，即使到现在 GitHub 上他的 Star 数仍然是众多图片加载库最多的。</p>
<p>可惜的是该作者在项目中说明，从去年的9月份，他就已经停止了对该项目的维护。这就意味着以后任何的 bug 都不会修复，任何的新特性都不会再继续开发，所以毫无疑问 UIL 不推荐在项目中使用了。</p>
<h2 id="2-Picasso"><a href="#2-Picasso" class="headerlink" title="2. Picasso"></a>2. Picasso</h2><p><code>https://github.com/square/picasso</code></p>
<p>Picasso 是 Square 公司的大作，名字起的也这么文艺，叫「毕加索」，意为加载图片就像画画一样，是一门艺术。这个库是我之前一直很喜欢的，因为他不仅具备图片加载应有尽有的强大功能，他的调用也是如此简洁文艺：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Picasso.with(context).load(<span class="string">"http://i.imgur.com/DvpvklR.png"</span>).into(imageView);</div></pre></td></tr></table></figure>
<p>以上代码就是给一个 ImageView 加载远程图片的一个示例，是不是很简洁？</p>
<p>当然不止如此，他还提供更多的用法，足以满足你实际项目中的各种需求，具体这些用法本文就不提了，可以去官网自行研究。</p>
<h2 id="3-Glide"><a href="#3-Glide" class="headerlink" title="3. Glide"></a>3. Glide</h2><p><code>https://github.com/bumptech/glide</code></p>
<p>Glide 是 Google 一位员工的大作，他完全是基于 Picasso 的，沿袭了 Picasso 的简洁风格，但是在此做了大量优化与改进。</p>
<p>Glide 默认的 Bitmap 格式是 RGB_565 格式，而 Picasso 默认的是 ARGB_8888 格式，这个内存开销要小一半。</p>
<p>在磁盘缓存方面，Picasso 只会缓存原始尺寸的图片，而 Glide 缓存的是多种规格，也就意味着 Glide 会根据你 ImageView 的大小来缓存相应大小的图片尺寸，比如你 ImageView 大小是200<em>200，原图是 400</em>400 ，而使用 Glide 就会缓存 200<em>200 规格的图，而 Picasso 只会缓存 400</em>400 规格的。这个改进就会导致 Glide 比 Picasso 加载的速度要快，毕竟少了每次裁剪重新渲染的过程。</p>
<p>最重要的一个特性是 Glide 支持加载 Gif 动态图，而 Picasso 不支持该特性。</p>
<p>除此之外，还有很多其他配置选项的增加。</p>
<p>总体来说，Glide 是在 Picasso 基础之上进行的二次开发，各个方面做了不少改进，不过这也导致他的包比 Picasso 大不少，不过也就不到 500k，Picasso 是100多k，方法数也比 Picasso 多不少，不过毕竟级别还是蛮小的，影响不是很大。</p>
<h2 id="4-Fresco"><a href="#4-Fresco" class="headerlink" title="4. Fresco"></a>4. Fresco</h2><p><code>https://github.com/facebook/fresco</code></p>
<p>Fresco 是 Facebook 出品，他是新一代的图片加载库，我们知道 Android 应用程序可用的内存有限，经常会因为图片加载导致 OOM，虽然我们有各种手段去优化，尽量减少出现 OOM 的可能性，但是永远没法避免，尤其某些低端手机 OOM 更是严重。而 Facebook 就另辟蹊径，既然没法在 Java 层处理，我们就在更底层的 Native 堆做手脚。于是 Fresco 将图片放到一个特别的内存区域叫 Ashmem 区，就是属于 Native 堆，图片将不再占用 App 的内存，Java 层对此无能为力，这里是属于 C++ 的地盘，所以能大大的减少 OOM。</p>
<p>所以此库很强大，不过用起来也比较复杂，包也比较大，貌似有2、3M，底层涉及到的 C++ 领域，想读源码也比较困难。</p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>综合来看，毫无疑问 Glide 与 Picasso 之间优先推荐选择 Glide，尤其是如果你的项目想要支持 Gif 动态图，那更该选择 Glide 。</p>
<p>但是如果你的项目使用了 Square 公司的全家桶，如 Retrofit 或者 OkHttp ，那么搭配 Picasso 一起使用也不是不可，兼容性可能会更好些，占用体积也会少些。</p>
<p>对于一般的 App 使用 Fresco 未免有些大材小用了，大部分情况 Glide 都能满足你的需求了，但是如果你的 App 中大量使用图片，比如是类似 Instagram 一类的图片社交 App ，那么推荐使用 Fresco ，虽然稍复杂，但是还是推荐使用 Fresco ，对提升你 App 的性能与体验有不少帮助，值得花时间去研究并应用到自己的 App 上来。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/06/24/图片加载框架介绍/" data-id="cixbj8xjy000g44tfe52da6jk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fresco/">Fresco</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Glide/">Glide</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Picasso/">Picasso</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UniversalImageLoader/">UniversalImageLoader</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android消息机制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/26/Android消息机制/" class="article-date">
  <time datetime="2015-10-26T15:56:53.000Z" itemprop="datePublished">2015-10-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android消息机制/">Android消息机制</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/26/Android消息机制/">Android的消息机制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Android的消息机制是日常开发不可避免涉及的部分,从开发角度来讲,Handler是Android消息机制的上层接口,这样使得在开发过程中只需要和Handler交互即可.Handler的使用过程很简单,通过它可以轻松的将一个任务切换到Handler所在的线程中去执行.很多人认为Handler的作用是更新UI,这的确没错,但是这只是Handler的一个特殊使用场景.具体来说是这样的:有时候需要在子线程中进行耗时的I/O操作,可能是读写文件或者访问网络等,当耗时的操作完成后可能需要在UI上做一些变化,由于Android开发规范的限制,我们并不能在子线程中访问UI控件,否则就会触发程序异常,这个时候就可以通过Handler来将更新UI的操作切换到主线程中去执行.因此,从本质上来说,handler并不是专门用来更新UI的,他只是常常被开发者用来更新UI.</p>
<p>Android的消息机制主要指的是Handler的运行机制,Handler的运行需要底层的MessageQueue和Looper的支撑.MessageQueue我们称之为消息队列,用于存储消息,是采用单链表的数据结构实现的存储列消息列表的.Looper-循环. 由于MessageQueue只是一个消息的存储单元,他不能去处理消息,而Looper就填补了这个功能,Looper会以无限循环的形式去查找是否有新消息,如果有就处理消息,如果没就等待.Looper中海油一个特殊的概念,就是ThreadLocal,ThreadLocal并不是线程.他的作用是可以在每个线程中存储数据.我们知道,Handler创建的时候就会采用当前线程的Looper来构造消息循环系统,那么Handler内部如何获取到当前线程的Looper呢?那就要使用ThreadLocal了,ThreadLocal可以在不同的线程中互不干涉地存储并提供数据,通过ThreadLocal可以轻松的获取到每个线程的Looper.当然需要注意的是,线程默认是没有Looper的,如果需要使用Handler就必须为线程创建Looper.我们经常提到的主线程,也叫UI线程,他就是ActivityThread,ActivityThread被创建时就会初始化Looper,这也是在主线程中默认可以使用Handler的原因.</p>
</blockquote>
<h1 id="1-Android的消息机制概述"><a href="#1-Android的消息机制概述" class="headerlink" title="1. Android的消息机制概述"></a>1. Android的消息机制概述</h1><p>Handler的主要作用是将一个任务切换到某个指定的线程中去执行.那么Android为什么提供这个功能呢?这是因为Android规定访问UI只能在主线程中进行,如果子线程访问UI,那么程序就会抛出异常,ViewRootImpl对UI操作做了验证,这个验证工作是由ViewRootImpl的checkThread方法来完成的,如下所示:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span>(mThread != Thread.currentThread())&#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(<span class="string">"Only the original thread that created a view hierarchy can touch its views"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Handler的工作原理,Handler创建时会采用当前线程的Looper来构建内部的消息循坏系统,如果当前的线程没有Looper,就会报错.</p>
<p>Handler创建完毕后,这个时候内部的Looper以及MessageQueue就可以和Handler一起协同工作了,然后通过Handler的post方法将一个Runnable投递到Handler内部的Looper中去处理,也可以通过Handler的send方法发送与一个消息,这个消息同样会在Looper中取去处理其实post方法最终也是通过send方法来实现的,接下来看send方法的工作过程.当Handler的send方法被调用时,他会调用MessageQueue的enqueueMessage方法将这个消息放入消息队列中,然后Looper发现有新消息到来时,就会处理这个消息,最终消息中的Runnable或者Handler中的handlerMessage方法就会被调用.注意Looper是运行在创建Handler所线程中的,这样一来Handler中的业务逻辑就会被切换到创建Handler所在的线程中取执行了.</p>
<p><img src="/images/hander.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/10/26/Android消息机制/" data-id="cixbj8xjk000c44tfcc62818l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Handler/">Handler</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Looper/">Looper</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/消息机制/">消息机制</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Binder源码分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/06/26/Binder源码分析/" class="article-date">
  <time datetime="2015-06-26T15:56:53.000Z" itemprop="datePublished">2015-06-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/源码分析/">源码分析</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/06/26/Binder源码分析/">Binder源码分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>目录</p>
</blockquote>
<ul>
<li>1.简介   </li>
<li>2.Binder与AIDL<ul>
<li>2.1 AIDL客户端</li>
<li>2.2 AIDL服务端</li>
<li>2.3 远程服务的获取与使用</li>
</ul>
</li>
<li>3.BInder框架及Native层<ul>
<li>3.1 Binder Native的入口</li>
<li>3.2 Binder 本地层的整个函数/方法调用过程</li>
<li>3.3 Binder设备文件的打开和读写 </li>
</ul>
</li>
<li>4.Binder驱动<ul>
<li>4.1 Binder设备的创建</li>
<li>4.2 Binder协议和数据结构</li>
<li>4.3 Binder驱动文件操作 </li>
</ul>
</li>
<li>5.Binder与系统服务</li>
<li>5.1 Context getSystemServie()</li>
<li>5.2 Context getSystemService()源码分析</li>
<li>6.结论</li>
<li>7.参考</li>
</ul>
<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p>Binder是一种Android进程间通信机制,提供远程过程调用(Remote Procedure Call)功能.我们最直接的使用是调用<code>Context.getSystemService()</code>来获取系统服务,或直接使用AIDl来实现多个程序(APP)间的数据交互.</p>
<p>Binder是非常重要的Android基础组件,几乎所有的进程间通信都是使用Binder机制实现的.本文将结合源码展开讲述Binder,同时对一些重要的知识点提供扩展阅读的参考.</p>
<p> <img src="/images/android_binder.png" alt=""></p>
<p>不管是Android系统服务(System Service)还是用户的应用进程(User apps),最终都会通过binder来实现进程间通信.上层应用首先通过IBinder的transcate方法发送命令给libbinder,libbinder再通过系统调用(ioctl)发送命令到内核中的binder驱动,之后再由驱动完成进程间数据的交互.</p>
<p>我们经常使用的Intent,Messager数据传递也是对Binder更高层次的抽象和封装,最终还是会由内核中的binder驱动完成数据的传递.</p>
<h2 id="2-Binder与AIDL"><a href="#2-Binder与AIDL" class="headerlink" title="2. Binder与AIDL"></a>2. Binder与AIDL</h2><p>AIDL(Android Interface definition language)是接口描述语言,用于生成在两个进程间进行通信的代码.先看AIDL概念图.</p>
<p> <img src="/images/AIDL.png" alt=""></p>
<ul>
<li>Stub.Proxy和Stub代码由Android Sdk自动生成,客户端通过Stub.Proxy与远程服务交互.</li>
<li>Stub包含对IBinder对象操作的封装,需要远程服务实现具体功能.</li>
</ul>
<p>接下来再看看具体实现,完整代码见<br> <a href="https://github.com/xdtianyu/AidlExample" target="_blank" rel="external">AidlExample</a>.在这个工程中,我们新建了两个应用,<code>app</code>是客户端代码,<code>remoteService</code>则是服务端代码.</p>
<h3 id="2-1-AIDL-客户端"><a href="#2-1-AIDL-客户端" class="headerlink" title="2.1 AIDL 客户端"></a>2.1 AIDL 客户端</h3><p>在Android Studio项目上右键,<code>New</code>-&gt;<code>AIDL</code>-&gt;<code>AIDL File</code>输入文件名后可以快速创建一个AIDL的代码结构.例如我们新建一个IRemoteService.aidl文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.android.aidltest;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span></span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong,</span></span></div><div class="line">	<span class="keyword">boolean</span> aBoolean,<span class="keyword">float</span> aFloat,<span class="keyword">double</span> aDouble,String aString);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从生成的示例代码可以看出来,AIDL的语法类似Java,<code>basicTypes()</code>方法传递的参数只是基本类型.<br>如果要传递自定义类型如<code>User</code>,则需要实现<code>Parcelable</code>接口.<code>Parcelable</code>是一个与Java <code>Serializable</code>类似的序列化接口.这样<code>User</code>的实例就可以存储到<code>Parcel</code>中,而<code>Parcel</code>则是一个可以通过IBinde发送数据或对象引用的容器.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// User.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> uid;</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="comment">// 从 Parcel 中读取数据，顺序需要和写入保持一致</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">User</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">        uid = in.readInt();</div><div class="line">        name = in.readString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 必须实现，用于从 Parcel 对象中生成类实例</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;User&gt; CREATOR = <span class="keyword">new</span> Creator&lt;User&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> User(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> User[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> User[size];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">// 将数据写入到 Parcel 中， 顺序需要与读取保持一致</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        dest.writeInt(uid);</div><div class="line">        dest.writeString(name);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再向<code>IRemoteService.aidl</code>中添加一个<code>addUser()</code>方法,同时新建一个 <code>User.aidl</code>文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// IRemoteService.aidl</span></div><div class="line"><span class="keyword">package</span> com.android.aidltest;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.android.aidltest.User;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IRemoteService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">            <span class="keyword">double</span> aDouble, String aString);</div><div class="line"></div><div class="line">    <span class="comment">// in 表示传入数据， out 表示传出数据， inout 表示双向传递。注意含有 out 时 User 类需要实现 readFromParcel() 方法</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addUser</span><span class="params">(in User user)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// User.aidl</span></div><div class="line"><span class="keyword">package</span> com.android.aidltest;</div><div class="line">parcelable User;</div></pre></td></tr></table></figure>
<p>运行编译后，会在 <code>generated</code> 文件夹中生成一个 <code>IRemoteService.java</code>接口文件。这个接口中有两个内部类 <code>Stub</code> 和 <code>Stub.Proxy</code>。注意客户端生成的<code>IRemoteService.java</code> 文件和在后文服务端生成的文件内容是相同的。</p>
<p>客户端会从 <code>Stub.asInterface()</code> 得到 <code>IRemoteService (Stub.Proxy)</code> 的实例，这个实例就是一个通过 Binder 传递回来的 <code>远程对象</code> 的包装。而服务端则需要实现 <code>IRemoteService.addUser()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// IRemoteService.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> org.xdty.remoteservice.<span class="function">IRemoteService <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</div><div class="line">    <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> org.xdty.remoteservice.IRemoteService))) &#123;</div><div class="line">        <span class="keyword">return</span> ((org.xdty.remoteservice.IRemoteService) iin);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> org.xdty.remoteservice.IRemoteService.Stub.Proxy(obj);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-AIDL服务端"><a href="#2-2-AIDL服务端" class="headerlink" title="2.2 AIDL服务端"></a>2.2 AIDL服务端</h3><p>为了演示进程间通信，我们新建一个模块（应用） <code>RemoteService</code>来实现功能，并在客户端绑定服务。</p>
<p>按客户端的结构新建 <code>IRemoteService.aidl User.aidl User.java</code> 文件，并拷贝内容，注意如果需要请修改包名。</p>
<p>新建服务 <code>RemoteService</code> ，覆盖(Override) <code>onBind()</code> 方法并返回 <code>IRemoteService.Stub</code> 实例 <code>mBinder</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// RemoteService.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RemoteService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = RemoteService.class.getSimpleName();</div><div class="line">    <span class="keyword">private</span> IBinder mBinder = <span class="keyword">new</span> IRemoteService.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">basicTypes</span><span class="params">(<span class="keyword">int</span> anInt, <span class="keyword">long</span> aLong, <span class="keyword">boolean</span> aBoolean, <span class="keyword">float</span> aFloat,</span></span></div><div class="line">                <span class="keyword">double</span> aDouble, String aString) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">            Log.d(TAG, <span class="string">"basicTypes: "</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            Log.d(TAG, <span class="string">"addUser: "</span> + user.name);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mBinder;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样服务端就实现了 <code>addUser()</code>方法，当客户端通过远程对象调用 <code>IRemoteService.Stub.Proxy.addUser()</code> 时，远程对象 mRemote 就会通过<code>transact()</code> 发送命令给服务端，服务端收到命令后在 <code>Stub.onTransact()</code> 中读取数据并执行 <code>addUser()</code> 方法。更多细节我们将在<code>3. Binder 框架及 Native 层</code> 小节讲述。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// IRemoteService.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply,</span></span></div><div class="line">        <span class="keyword">int</span> flags) <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">case</span> TRANSACTION_addUser: &#123;</div><div class="line">            data.enforceInterface(DESCRIPTOR);</div><div class="line">            org.xdty.remoteservice.User _arg0;</div><div class="line">            <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">                _arg0 = org.xdty.remoteservice.User.CREATOR.createFromParcel(data);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                _arg0 = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">this</span>.addUser(_arg0);</div><div class="line">            reply.writeNoException();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-3-远程服务的获取与使用"><a href="#2-3-远程服务的获取与使用" class="headerlink" title="2.3 远程服务的获取与使用"></a>2.3 远程服务的获取与使用</h3><p>客户端要使用远程服务，需要绑定服务 (<code>bindService</code>) 并建立服务连接 (<code>ServiceConnection</code>)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// MainActivity.java</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">            IRemoteService remoteService = IRemoteService.Stub.asInterface(service);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                remoteService.addUser(<span class="keyword">new</span> User(<span class="number">1</span>, <span class="string">"neo"</span>));</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent().setComponent(<span class="keyword">new</span> ComponentName(</div><div class="line">                <span class="string">"org.xdty.remoteservice"</span>,</div><div class="line">                <span class="string">"org.xdty.remoteservice.RemoteService"</span>));</div><div class="line">        bindService(intent, mConnection, Context.BIND_AUTO_CREATE);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看出，客户端通过 <code>binderService()</code> 方法，获取远程服务并在服务连接 <code>ServiceConnection</code> 中 <code>onServiceConnected()</code>回调中得到了 <code>IBinder service</code>实例， 最后通过上文提到的 <code>IRemoteService.Stub.asInterface(service)</code> 方法得到远程服务 <code>IRemoteService</code> 的实例。通过 <code>IRemoteService.addUser()</code> 方法我们可以像调用本地方法一样调用远程方法。在来看 <code>IRemoteService.addUser()</code> 的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// IRemoteService.java</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> org.xdty.remoteservice.<span class="function">IRemoteService <span class="title">asInterface</span><span class="params">(android.os.IBinder obj)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> org.xdty.remoteservice.IRemoteService.Stub.Proxy(obj);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">xdty</span>.<span class="title">remoteservice</span>.<span class="title">IRemoteService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> android.os.IBinder mRemote;</div><div class="line"></div><div class="line">    Proxy(android.os.IBinder remote) &#123;</div><div class="line">        mRemote = remote;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> android.os.<span class="function">IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mRemote;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(org.xdty.remoteservice.User user)</span></span></div><div class="line">            <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">        android.os.Parcel _data = android.os.Parcel.obtain();</div><div class="line">        android.os.Parcel _reply = android.os.Parcel.obtain();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            _data.writeInterfaceToken(DESCRIPTOR);</div><div class="line">            <span class="keyword">if</span> ((user != <span class="keyword">null</span>)) &#123;</div><div class="line">                _data.writeInt(<span class="number">1</span>);</div><div class="line">                user.writeToParcel(_data, <span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                _data.writeInt(<span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">            mRemote.transact(Stub.TRANSACTION_addUser, _data, _reply, <span class="number">0</span>);</div><div class="line">            _reply.readException();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            _reply.recycle();</div><div class="line">            _data.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到客户端调用 <code>remoteService.addUser(new User(1, &quot;neo&quot;))</code> 方法实际上是通过 <code>IBinder service</code> 实例的 <code>transact()</code> 方法，发送了与服务端约定好的命令 <code>Stub.TRANSACTION_addUser</code>，并将参数按格式打包进 <code>Parcel</code> 对象。</p>
<p>服务端则在 <code>onTransact()</code> 方法中收到命令后会对命令和参数重新解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// IRemoteService.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply,</span></span></div><div class="line">        <span class="keyword">int</span> flags) <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">case</span> TRANSACTION_addUser: &#123;</div><div class="line">            data.enforceInterface(DESCRIPTOR);</div><div class="line">            org.xdty.remoteservice.User _arg0;</div><div class="line">            <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">                _arg0 = org.xdty.remoteservice.User.CREATOR.createFromParcel(data);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                _arg0 = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">this</span>.addUser(_arg0);</div><div class="line">            reply.writeNoException();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到在 <code>onTransact()</code> 中，最终 <code>this.addUser(_arg0</code>) 调用了上文提到的服务端的实现 <code>IRemoteService.Stub.addUser()</code> 。</p>
<p>远程 Binder 对象 <code>mRemote</code> 是由客户端绑定服务时 <code>onServiceConnected()</code> 返回的。继续追踪 <code>bindService()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// ContextImpl.java</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">bindService</span><span class="params">(Intent service, ServiceConnection conn,</span></span></div><div class="line">        <span class="keyword">int</span> flags) &#123;</div><div class="line">    warnIfCallingFromSystemProcess();</div><div class="line">    <span class="keyword">return</span> bindServiceCommon(service, conn, flags, Process.myUserHandle());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到最后是通过 <code>ActivityManagerNative.getDefault().bindService()</code> 来绑定服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// bindServiceCommon()</span></div><div class="line"><span class="keyword">int</span> res = ActivityManagerNative.getDefault().bindService(</div><div class="line">    mMainThread.getApplicationThread(), getActivityToken(), service,</div><div class="line">    service.resolveTypeIfNeeded(getContentResolver()),</div><div class="line">    sd, flags, getOpPackageName(), user.getIdentifier());</div><div class="line"></div><div class="line"><span class="comment">// ActivityManagerNative.getDefault().bindService()</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">bindService</span><span class="params">(IApplicationThread caller, IBinder token,</span></span></div><div class="line">        Intent service, String resolvedType, IServiceConnection connection,</div><div class="line">        <span class="keyword">int</span> flags,  String callingPackage, <span class="keyword">int</span> userId) <span class="keyword">throws</span> RemoteException &#123;</div><div class="line">    ...</div><div class="line">    data.writeStrongBinder(connection.asBinder());</div><div class="line">    ...</div><div class="line">    mRemote.transact(BIND_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>追踪到 <code>ActivityManagerNative.getDefault().bindService()</code> ，可以发现<code>ActivityManager</code> 和 <code>IServiceConnection</code>也是一个 AIDL 实现。通过它的 <code>ActivityManagerProxy.bindService()</code> 将绑定请求发送给本地层。</p>
<p>再从 <code>onServiceConnected()</code>回调追踪， <code>onServiceConnected()</code> 是由 <code>LoadedApk.ServiceDispatcher.doConnected()</code> 回调的。</p>
<p>关于更多的 <code>bindService()</code> 远程服务创建及 <code>ServiceConnection</code> 回调， 请参考 Android应用程序绑定服务（bindService）的过程源代码分析</p>
<ul>
<li>利用进程间通信，我们可以实现简单的应用插件功能。关于 AIDL 在实际项目中的应用，可以参考 <code>CallerInfo Plugin</code>的实现</li>
</ul>
<p>从上面分析可以看出， AIDL 的本质是对 Binder 的又一次抽象和封装，实际的进程间通信仍是由 Binder 完成的。</p>
<h2 id="3-Binder框架及Native层"><a href="#3-Binder框架及Native层" class="headerlink" title="3. Binder框架及Native层"></a>3. Binder框架及Native层</h2><p>Binder机制使本地对象可以像操作当前对象一样调用远程对象，可以使不同的进程间互相通信。Binder 使用 Client/Server 架构，客户端通过服务端代理，经过 Binder 驱动与服务端交互。</p>
<p> <img src="/images/Binder.png" alt=""></p>
<p>Binder 机制实现进程间通信的奥秘在于 kernel 中的 Binder 驱动，将在 <code>4. Binder</code>驱动 小节详细讲述。</p>
<p>  <img src="/images/binder_native.png" alt=""></p>
<p>JNI 的代码位于 <code>frameworks/base/core/jni</code> 目录下，主要是 <code>android_util_Binder.cpp</code>文件和头文件 <code>android_util_Binder.h</code></p>
<p>Binder JNI 代码是 Binder Java 层操作到 Binder Native 层的接口封装，最后会被编译进 <code>libandroid_runtime.so</code> 系统库。</p>
<p>Binder 本地层的代码在 <code>frameworks/native/libs/binder</code> 目录下， 此目录在 Android 系统编译后会生成 <code>libbinder.so</code> 文件，供 JNI 调用。<code>libbinder</code> 封装了所有对 binder 驱动的操作，是上层应用与驱动交互的桥梁。头文件则在 <code>frameworks/native/include/binder</code> 目录下。</p>
<h3 id="3-1-Binder-Native-的入口"><a href="#3-1-Binder-Native-的入口" class="headerlink" title="3.1 Binder Native 的入口"></a>3.1 Binder Native 的入口</h3><p><code>IInterface.cpp</code> 是 Binder 本地层入口，与 java 层的 <code>android.os.IInterface</code> 对应，提供 <code>asBinder()</code> 的实现，返回 <code>IBinder</code> 对象。</p>
<p>在头文件中有两个类 <code>BnInterface (Binder Native Interface)</code> 和 <code>BpInterface (Binder Proxy Interface)</code>, 对应于 java 层的 <code>Stub</code> 和 <code>Proxy</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">sp&lt;IBinder&gt; IInterface::asBinder(<span class="keyword">const</span> IInterface* iface)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (iface == NULL) <span class="keyword">return</span> NULL;</div><div class="line">    <span class="keyword">return</span> const_cast&lt;IInterface*&gt;(iface)-&gt;onAsBinder();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">template&lt;typename INTERFACE&gt;</div><div class="line">class BnInterface : public INTERFACE, public BBinder</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    virtual sp&lt;IInterface&gt;      queryLocalInterface(const String16&amp; _descriptor);</div><div class="line">    virtual const String16&amp;     getInterfaceDescriptor() const;</div><div class="line"></div><div class="line">protected:</div><div class="line">    virtual IBinder*            onAsBinder();</div><div class="line">&#125;;</div><div class="line"></div><div class="line">// ----------------------------------------------------------------------</div><div class="line"></div><div class="line">template&lt;typename INTERFACE&gt;</div><div class="line">class BpInterface : public INTERFACE, public BpRefBase</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">                                BpInterface(const sp&lt;IBinder&gt;&amp; remote);</div><div class="line"></div><div class="line">protected:</div><div class="line">    virtual IBinder*            onAsBinder();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中 <code>BnInterface</code> 是实现Stub功能的模板，扩展BBinder的onTransact()方法实现Binder命令的解析和执行。<code>BpInterface</code> 是实现Proxy功能的模板，BpRefBase里有个mRemote对象指向一个BpBinder对象。</p>
<h3 id="3-2-Binder-本地层的整个函数-方法调用过程"><a href="#3-2-Binder-本地层的整个函数-方法调用过程" class="headerlink" title="3.2 Binder 本地层的整个函数/方法调用过程"></a>3.2 Binder 本地层的整个函数/方法调用过程</h3><p><img src="/images/binder_native_stack.png" alt=""></p>
<ol>
<li><p>Java 层 <code>IRemoteService.Stub.Proxy</code> 调用<br><code>android.os.IBinder (实现在 android.os.Binder.BinderProxy)</code>的 <code>transact()</code> 发送 <code>Stub.TRANSACTION_addUser</code> 命令。</p>
</li>
<li><p>由 <code>BinderProxy.transact()</code> 进入 native 层。</p>
</li>
<li><p>由 <code>jni</code> 转到 <code>android_os_BinderProxy_transact()</code> 函数。</p>
</li>
<li><p>调用 <code>IBinder-&gt;transac</code>t 函数。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">android_os_BinderProxy_transact</span><span class="params">(JNIEnv* env, jobject obj,</span></span></div><div class="line">        jint code, jobject dataObj, jobject replyObj, jint flags) <span class="comment">// throws RemoteException</span></div><div class="line">&#123;</div><div class="line">    IBinder* target = (IBinder*)</div><div class="line">        env-&gt;GetLongField(obj, gBinderProxyOffsets.mObject);</div><div class="line">    status_t err = target-&gt;transact(code, *data, reply, flags);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而 <code>gBinderProxyOffsets.mObject</code> 则是在 java 层调用 <code>IBinder.getContextObject()</code> 时在 <code>javaObjectForIBinder</code> 函数中设置的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">android_os_BinderInternal_getContextObject</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></div><div class="line">&#123;</div><div class="line">    sp&lt;IBinder&gt; b = ProcessState::self()-&gt;getContextObject(NULL);</div><div class="line">    <span class="keyword">return</span> javaObjectForIBinder(env, b);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">jobject <span class="title">javaObjectForIBinder</span><span class="params">(JNIEnv* env, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; val)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    LOGDEATH(<span class="string">"objectForBinder %p: created new proxy %p !\n"</span>, val.get(), object);</div><div class="line">    <span class="comment">// The proxy holds a reference to the native object.</span></div><div class="line">    env-&gt;SetLongField(object, gBinderProxyOffsets.mObject, (jlong)val.get());</div><div class="line">    val-&gt;incStrong((<span class="keyword">void</span>*)javaObjectForIBinder);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>经过 <code>ProcessState::getContextObject()</code>和 <code>ProcessState::getStrongProxyForHandle()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">sp&lt;IBinder&gt; ProcessState::getContextObject(<span class="keyword">const</span> sp&lt;IBinder&gt;&amp; <span class="comment">/*caller*/</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> getStrongProxyForHandle(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">sp&lt;IBinder&gt; ProcessState::getStrongProxyForHandle(int32_t handle)</div><div class="line">&#123;</div><div class="line">    sp&lt;IBinder&gt; result;</div><div class="line">    ...</div><div class="line">    b = <span class="keyword">new</span> BpBinder(handle); </div><div class="line">    result = b;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见 <code>android_os_BinderProxy_transact()</code> 函数实际上调用的是 <code>BpBinder::transact()</code> 函数。</p>
<p> 5.<code>BpBinder::transact()</code> 则又调用了 <code>IPCThreadState::self()-&gt;transact()</code> 函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">status_t IPCThreadState::transact(int32_t handle,</div><div class="line">                                  uint32_t code, <span class="keyword">const</span> Parcel&amp; data,</div><div class="line">                                  Parcel* reply, uint32_t flags)</div><div class="line">&#123;</div><div class="line">    status_t err = data.errorCheck();</div><div class="line"></div><div class="line">    flags |= TF_ACCEPT_FDS;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == NO_ERROR) &#123;</div><div class="line">        LOG_ONEWAY(<span class="string">"&gt;&gt;&gt;&gt; SEND from pid %d uid %d %s"</span>, getpid(), getuid(),</div><div class="line">            (flags &amp; TF_ONE_WAY) == <span class="number">0</span> ? <span class="string">"READ REPLY"</span> : <span class="string">"ONE WAY"</span>);</div><div class="line">        err = writeTransactionData(BC_TRANSACTION, flags, handle, code, data, NULL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((flags &amp; TF_ONE_WAY) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (reply) &#123;</div><div class="line">            err = waitForResponse(reply);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Parcel fakeReply;</div><div class="line">            err = waitForResponse(&amp;fakeReply);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        err = waitForResponse(NULL, NULL);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> err;</div><div class="line">&#125;</div><div class="line"></div><div class="line">status_t IPCThreadState::writeTransactionData(int32_t cmd, uint32_t binderFlags,</div><div class="line">    int32_t handle, uint32_t code, <span class="keyword">const</span> Parcel&amp; data, status_t* statusBuffer)</div><div class="line">&#123;</div><div class="line">    binder_transaction_data tr;</div><div class="line"></div><div class="line">    tr.target.ptr = <span class="number">0</span>; <span class="comment">/* Don't pass uninitialized stack data to a remote process */</span></div><div class="line">    tr.target.handle = handle;</div><div class="line">    tr.code = code;</div><div class="line">    ...</div><div class="line"></div><div class="line">    mOut.writeInt32(cmd);</div><div class="line">    mOut.write(&amp;tr, sizeof(tr));</div><div class="line"></div><div class="line">    <span class="keyword">return</span> NO_ERROR;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由函数内容可以看出， 数据再一次通过 <code>writeTransactionData()</code> 传递给 <code>mOut</code> 进行写入操作。 <code>mOut</code> 是一个 Parcel 对象， 声明在 <code>IPCThreadState.h</code>文件中。之后则调用<code>waitForResponse()</code>函数。</p>
<p>6.<code>IPCThreadState::waitForResponse()</code> 在一个 <code>while</code> 循环里不断的调用 <code>talkWithDriver()</code> 并检查是否有数据返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">status_t IPCThreadState::waitForResponse(Parcel *reply, status_t *acquireResult)</div><div class="line">&#123;</div><div class="line">    uint32_t cmd;</div><div class="line">    int32_t err;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">if</span> ((err=talkWithDriver()) &lt; NO_ERROR) <span class="keyword">break</span>;</div><div class="line">        ...</div><div class="line"></div><div class="line">        cmd = (uint32_t)mIn.readInt32();</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (cmd) &#123;</div><div class="line">        <span class="keyword">case</span> BR_TRANSACTION_COMPLETE:</div><div class="line">            ...</div><div class="line"></div><div class="line">        <span class="keyword">case</span> BR_REPLY:</div><div class="line">            &#123;</div><div class="line">                binder_transaction_data tr;</div><div class="line">                err = mIn.read(&amp;tr, sizeof(tr));</div><div class="line">                ALOG_ASSERT(err == NO_ERROR, <span class="string">"Not enough command data for brREPLY"</span>);</div><div class="line">                <span class="keyword">if</span> (err != NO_ERROR) goto finish;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (reply) &#123;</div><div class="line">                    <span class="keyword">if</span> ((tr.flags &amp; TF_STATUS_CODE) == <span class="number">0</span>) &#123;</div><div class="line">                        reply-&gt;ipcSetDataReference(</div><div class="line">                            reinterpret_cast&lt;<span class="keyword">const</span> uint8_t*&gt;(tr.data.ptr.buffer),</div><div class="line">                            tr.data_size,</div><div class="line">                            reinterpret_cast&lt;<span class="keyword">const</span> binder_size_t*&gt;(tr.data.ptr.offsets),</div><div class="line">                            tr.offsets_size/sizeof(binder_size_t),</div><div class="line">                            freeBuffer, <span class="keyword">this</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        err = *reinterpret_cast&lt;<span class="keyword">const</span> status_t*&gt;(tr.data.ptr.buffer);</div><div class="line">                        freeBuffer(NULL,</div><div class="line">                            reinterpret_cast&lt;<span class="keyword">const</span> uint8_t*&gt;(tr.data.ptr.buffer),</div><div class="line">                            tr.data_size,</div><div class="line">                            reinterpret_cast&lt;<span class="keyword">const</span> binder_size_t*&gt;(tr.data.ptr.offsets),</div><div class="line">                            tr.offsets_size/sizeof(binder_size_t), <span class="keyword">this</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    freeBuffer(NULL,</div><div class="line">                        reinterpret_cast&lt;<span class="keyword">const</span> uint8_t*&gt;(tr.data.ptr.buffer),</div><div class="line">                        tr.data_size,</div><div class="line">                        reinterpret_cast&lt;<span class="keyword">const</span> binder_size_t*&gt;(tr.data.ptr.offsets),</div><div class="line">                        tr.offsets_size/sizeof(binder_size_t), <span class="keyword">this</span>);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            goto finish;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            err = executeCommand(cmd);</div><div class="line">            <span class="keyword">if</span> (err != NO_ERROR) goto finish;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>7.<code>IPCThreadState::talkWithDriver()</code> 函数是真正与 binder 驱动交互的实现。<code>ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr)</code>就是使用系统调用函数 <code>ioctl</code> 向 binder 设备文件 <code>/dev/binder</code>发送 <code>BINDER_WRITE_READ</code> 命令。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">status_t IPCThreadState::talkWithDriver(bool doReceive)</div><div class="line">&#123;</div><div class="line">    if (mProcess-&gt;mDriverFD &lt;= 0) &#123;</div><div class="line">        return -EBADF;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    binder_write_read bwr;</div><div class="line"></div><div class="line">    // Is the read buffer empty?</div><div class="line">    const bool needRead = mIn.dataPosition() &gt;= mIn.dataSize();</div><div class="line"></div><div class="line">    // We don't want to write anything if we are still reading</div><div class="line">    // from data left in the input buffer and the caller</div><div class="line">    // has requested to read the next data.</div><div class="line">    const size_t outAvail = (!doReceive || needRead) ? mOut.dataSize() : 0;</div><div class="line"></div><div class="line">    bwr.write_size = outAvail;</div><div class="line">    bwr.write_buffer = (uintptr_t)mOut.data();</div><div class="line"></div><div class="line">    // This is what we'll read.</div><div class="line">    if (doReceive &amp;&amp; needRead) &#123;</div><div class="line">        bwr.read_size = mIn.dataCapacity();</div><div class="line">        bwr.read_buffer = (uintptr_t)mIn.data();</div><div class="line">    &#125; else &#123;</div><div class="line">        bwr.read_size = 0;</div><div class="line">        bwr.read_buffer = 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Return immediately if there is nothing to do.</div><div class="line">    if ((bwr.write_size == 0) &amp;&amp; (bwr.read_size == 0)) return NO_ERROR;</div><div class="line"></div><div class="line">    bwr.write_consumed = 0;</div><div class="line">    bwr.read_consumed = 0;</div><div class="line">    status_t err;</div><div class="line"></div><div class="line">#if defined(HAVE_ANDROID_OS)</div><div class="line">        // 使用系统调用 ioctl 向 /dev/binder 发送 BINDER_WRITE_READ 命令</div><div class="line">        if (ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= 0)</div><div class="line">            err = NO_ERROR;</div><div class="line">        else</div><div class="line">            err = -errno;</div><div class="line">#else</div><div class="line">        err = INVALID_OPERATION;</div><div class="line">#endif</div><div class="line"></div><div class="line">    do &#123;</div><div class="line">        if (mProcess-&gt;mDriverFD &lt;= 0) &#123;</div><div class="line">            err = -EBADF;</div><div class="line">        &#125;</div><div class="line">    &#125; while (err == -EINTR);</div><div class="line"></div><div class="line">    if (err &gt;= NO_ERROR) &#123;</div><div class="line">        if (bwr.write_consumed &gt; 0) &#123;</div><div class="line">            if (bwr.write_consumed &lt; mOut.dataSize())</div><div class="line">                mOut.remove(0, bwr.write_consumed);</div><div class="line">            else</div><div class="line">                mOut.setDataSize(0);</div><div class="line">        &#125;</div><div class="line">        if (bwr.read_consumed &gt; 0) &#123;</div><div class="line">            mIn.setDataSize(bwr.read_consumed);</div><div class="line">            mIn.setDataPosition(0);</div><div class="line">        &#125;</div><div class="line">        return NO_ERROR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return err;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>经过 <code>IPCThreadState::talkWithDriver()</code> ,就将数据发送给了 Binder 驱动。</p>
<p>继续追踪 <code>IPCThreadState::waitForResponse()</code> ，可以从 第6步 发现 <code>IPCThreadState</code> 不断的循环读取 Binder 驱动返回，获取到返回命令后执行了 <code>executeCommand(cmd)</code> 函数。</p>
<p>8.<code>IPCThreadState::executeCommand()</code> 处理 Binder 驱动返回命令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">status_t IPCThreadState::executeCommand(int32_t cmd)</div><div class="line">&#123;</div><div class="line">    BBinder* obj;</div><div class="line">    RefBase::weakref_type* refs;</div><div class="line">    status_t result = NO_ERROR;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> ((uint32_t)cmd) &#123;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">case</span> BR_TRANSACTION:</div><div class="line">        &#123;</div><div class="line">            binder_transaction_data tr;</div><div class="line">            result = mIn.read(&amp;tr, sizeof(tr));</div><div class="line">            ...</div><div class="line">            Parcel buffer;</div><div class="line">            buffer.ipcSetDataReference(</div><div class="line">                reinterpret_cast&lt;<span class="keyword">const</span> uint8_t*&gt;(tr.data.ptr.buffer),</div><div class="line">                tr.data_size,</div><div class="line">                reinterpret_cast&lt;<span class="keyword">const</span> binder_size_t*&gt;(tr.data.ptr.offsets),</div><div class="line">                tr.offsets_size/sizeof(binder_size_t), freeBuffer, <span class="keyword">this</span>);</div><div class="line">            ...</div><div class="line"></div><div class="line">            Parcel reply;</div><div class="line">            status_t error;</div><div class="line">            <span class="keyword">if</span> (tr.target.ptr) &#123;</div><div class="line">                <span class="function">sp&lt;BBinder&gt; <span class="title">b</span><span class="params">((BBinder*)</span>tr.cookie)</span>;</div><div class="line">                error = b-&gt;transact(tr.code, buffer, &amp;reply, tr.flags);</div><div class="line"></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                error = the_context_object-&gt;transact(tr.code, buffer, &amp;reply, tr.flags);</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>9.可以看出其调用了 <code>BBinder::transact()</code> 函数，将数据返回给上层。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">status_t BBinder::transact(</div><div class="line">    uint32_t code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, uint32_t flags)</div><div class="line">&#123;</div><div class="line">    data.setDataPosition(<span class="number">0</span>);</div><div class="line"></div><div class="line">    status_t err = NO_ERROR;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">        <span class="keyword">case</span> PING_TRANSACTION:</div><div class="line">            reply-&gt;writeInt32(pingBinder());</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            err = onTransact(code, data, reply, flags);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (reply != NULL) &#123;</div><div class="line">        reply-&gt;setDataPosition(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>10.而这里的<code>b-&gt;transact(tr.code, buffer, &amp;reply, tr.flags)</code> 中的 <code>b (BBinder)</code> 是 JavaBBinder 的实例，所以会调用 <code>JavaBBinder::onTransact()</code> 函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// frameworks/base/core/jni/android_util_Binder.cpp</span></div><div class="line"><span class="function">virtual status_t <span class="title">onTransact</span><span class="params">(</span></span></div><div class="line">        uint32_t code, <span class="keyword">const</span> Parcel&amp; data, Parcel* reply, uint32_t flags = <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        JNIEnv* env = javavm_to_jnienv(mVM);</div><div class="line">        ...</div><div class="line">        jboolean res = env-&gt;CallBooleanMethod(mObject, gBinderOffsets.mExecTransact,</div><div class="line">            code, reinterpret_cast&lt;jlong&gt;(&amp;data), reinterpret_cast&lt;jlong&gt;(reply), flags);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">int_register_android_os_Binder</span><span class="params">(JNIEnv* env)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    gBinderOffsets.mExecTransact = GetMethodIDOrDie(env, clazz, <span class="string">"execTransact"</span>, <span class="string">"(IJJI)Z"</span>);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>11.可见 JNI 通过 <code>gBinderOffsets.mExecTransact</code> 最后执行了 <code>android.os.Binder</code> 的 <code>execTransact()</code> 方法。</p>
<p><code>execTransact()</code>方法是 jni 回调的入口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// Entry point from android_util_Binder.cpp's onTransact</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">execTransact</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">long</span> dataObj, <span class="keyword">long</span> replyObj,</span></span></div><div class="line">            <span class="keyword">int</span> flags) &#123;</div><div class="line">        Parcel data = Parcel.obtain(dataObj);</div><div class="line">        Parcel reply = Parcel.obtain(replyObj);</div><div class="line">        ...</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            res = onTransact(code, data, reply, flags);</div><div class="line">        &#125; </div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>12.而我们则在服务端 <code>IRemoteService.Stub</code> 重载了<code>onTransact()</code> 方法，所以数据最后会回到我们的服务端并执行服务端实现的 <code>addUser()</code> 方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">Binder</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">org</span>.<span class="title">xdty</span>.<span class="title">remoteservice</span>.<span class="title">IRemoteService</span> &#123;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply,</span></span></div><div class="line">            <span class="keyword">int</span> flags) <span class="keyword">throws</span> android.os.RemoteException &#123;</div><div class="line">        <span class="keyword">switch</span> (code) &#123;</div><div class="line">            <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</div><div class="line">                reply.writeString(DESCRIPTOR);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> TRANSACTION_basicTypes: &#123;</div><div class="line">                ...</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> TRANSACTION_addUser: &#123;</div><div class="line">                data.enforceInterface(DESCRIPTOR);</div><div class="line">                org.xdty.remoteservice.User _arg0;</div><div class="line">                <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</div><div class="line">                    _arg0 = org.xdty.remoteservice.User.CREATOR.createFromParcel(data);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    _arg0 = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">this</span>.addUser(_arg0);</div><div class="line">                reply.writeNoException();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述过程就是所有的 <code>Native</code> 层客户端到服务端的调用过程，总结下来就是 客户端进程发送 <code>BC_TRANSACTION</code> 到 Binder 驱动，服务端进程监听返回的 <code>BR_TRANSACTION</code> 命令并处理。如果是服务端向客户端返回数据，类似的是服务端发送 <code>BC_REPLY</code> 命令， 客户端监听 <code>BR_REPLY</code> 命令。</p>
<h3 id="3-3-Binder设备文件的打开和读写"><a href="#3-3-Binder设备文件的打开和读写" class="headerlink" title="3.3 Binder设备文件的打开和读写"></a>3.3 Binder设备文件的打开和读写</h3><p><strong>1. 设备的打开</strong></p>
<p>在上一小节中我们看到 JNI 过程中调用了 ProcessState::getContextObject() 函数， 在 ProcessState 初始化时会打开 binder 设备<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// ProcessState.cpp</span></div><div class="line">ProcessState::ProcessState()</div><div class="line">    : mDriverFD(open_driver())</div><div class="line">    ...</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>open_driver()</code> 函数内容如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ProcessState.cpp</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">open_driver</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 打开设备文件</span></div><div class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/binder"</span>, O_RDWR);</div><div class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</div><div class="line">        fcntl(fd, F_SETFD, FD_CLOEXEC);</div><div class="line">        <span class="keyword">int</span> vers = <span class="number">0</span>;</div><div class="line">        <span class="comment">// 获取驱动版本</span></div><div class="line">        status_t result = ioctl(fd, BINDER_VERSION, &amp;vers);</div><div class="line">        <span class="keyword">if</span> (result == -<span class="number">1</span>) &#123;</div><div class="line">            ALOGE(<span class="string">"Binder ioctl to obtain version failed: %s"</span>, strerror(errno));</div><div class="line">            close(fd);</div><div class="line">            fd = -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 检查驱动版本是否一致</span></div><div class="line">        <span class="keyword">if</span> (result != <span class="number">0</span> || vers != BINDER_CURRENT_PROTOCOL_VERSION) &#123;</div><div class="line">            ALOGE(<span class="string">"Binder driver protocol does not match user space protocol!"</span>);</div><div class="line">            close(fd);</div><div class="line">            fd = -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 设置最多 15 个 binder 线程</span></div><div class="line">        size_t maxThreads = DEFAULT_MAX_BINDER_THREADS;</div><div class="line">        result = ioctl(fd, BINDER_SET_MAX_THREADS, &amp;maxThreads);</div><div class="line">        <span class="keyword">if</span> (result == -<span class="number">1</span>) &#123;</div><div class="line">            ALOGE(<span class="string">"Binder ioctl to set max threads failed: %s"</span>, strerror(errno));</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ALOGW(<span class="string">"Opening '/dev/binder' failed: %s\n"</span>, strerror(errno));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> fd;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>2.设备的读写</strong></p>
<p>打开设备文件后，文件描述符被保存在 <code>mDriverFD</code>， 通过系统调用 <code>ioctl</code> 函数操作 <code>mDriverFD</code> 就可以实现和 <code>binder</code> 驱动的交互。</p>
<p>对 Binder 设备文件的所有读写及关闭操作则都在 <code>IPCThreadState</code> 中，如上一小节提及到的 <code>IPCThreadState::talkWithDriver</code> 函数</p>
<p><code>talkWithDriver()</code> 函数封装了 <code>BINDER_WRITE_READ</code> 命令，会从 binder 驱动读取或写入封装在 <code>binder_write_read</code> 结构体中的本地或远程对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IPCThreadState.cpp</span></div><div class="line">status_t IPCThreadState::talkWithDriver(bool doReceive)</div><div class="line">&#123;   </div><div class="line">    binder_write_read bwr;</div><div class="line">    <span class="keyword">const</span> bool needRead = mIn.dataPosition() &gt;= mIn.dataSize();</div><div class="line">    <span class="keyword">const</span> size_t outAvail = (!doReceive || needRead) ? mOut.dataSize() : <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 写入数据</span></div><div class="line">    bwr.write_size = outAvail;</div><div class="line">    bwr.write_buffer = (uintptr_t)mOut.data();</div><div class="line"></div><div class="line">    <span class="comment">// 读取数据</span></div><div class="line">    <span class="keyword">if</span> (doReceive &amp;&amp; needRead) &#123;</div><div class="line">        bwr.read_size = mIn.dataCapacity();</div><div class="line">        bwr.read_buffer = (uintptr_t)mIn.data();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        bwr.read_size = <span class="number">0</span>;</div><div class="line">        bwr.read_buffer = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 使用 ioctl 系统调用发送 BINDER_WRITE_READ 命令到 biner 驱动</span></div><div class="line">    <span class="keyword">if</span> (ioctl(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="number">0</span>)</div><div class="line">        err = NO_ERROR;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出，本地层是对应用与 binder 驱动交互的直接封装与实现，最终的数据传输仍是由驱动来完成的。本地层对底层驱动进行了完整的封装，上层应用只关心 transact() 和 onTransact() 回调，察觉不到 binder 驱动的存在，减轻了上层应用进程间通信开发的复杂度。</p>
<h2 id="4-Binder-驱动"><a href="#4-Binder-驱动" class="headerlink" title="4.Binder 驱动"></a>4.Binder 驱动</h2><p>关于 binder 驱动建议参考另一篇文章 <code>深入分析Android Binder</code> 驱动 [原文](<code>Android Binder</code>，本小节仍需要完善。</p>
<p>Binder 驱动是 Binder 的最终实现， ServiceManager 和 Client/Service 进程间通信最终都是由 Binder 驱动投递的。</p>
<p> <img src="/images/binder_reference.png" alt=""></p>
<p>Binder 驱动的代码位于 kernel 代码的 <code>drivers/staging/android</code> 目录下。主文件是 <code>binder.h</code> 和 <code>binder.c</code></p>
<p>进程间传输的数据被称为 Binder 对象，它是一个 <code>flat_binder_object</code>，结构如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">struct flat_binder_object &#123;</div><div class="line">    <span class="comment">/* 8 bytes for large_flat_header. */</span></div><div class="line">    unsigned <span class="keyword">long</span>       type;</div><div class="line">    unsigned <span class="keyword">long</span>       flags;</div><div class="line"></div><div class="line">    <span class="comment">/* 8 bytes of data. */</span></div><div class="line">    union &#123;</div><div class="line">        <span class="keyword">void</span>        *binder;    <span class="comment">/* local object */</span></div><div class="line">        signed <span class="keyword">long</span> handle;     <span class="comment">/* remote object */</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="comment">/* extra data associated with local object */</span></div><div class="line">    <span class="keyword">void</span>            *cookie;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中 类型 <code>type</code> 描述了 Binder 对象的类型，包含 <code>BINDER</code>(本地对象)、<code>HANDLE</code>(远程对象)、 <code>FD</code> 三大类(五种)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    BINDER_TYPE_BINDER  = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_WEAK_BINDER = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_HANDLE  = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_WEAK_HANDLE = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_FD      = B_PACK_CHARS(<span class="string">'f'</span>, <span class="string">'d'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>flags</code> 则表述了<code>传输方式</code>，如异步、无返回等</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> transaction_flags &#123;</div><div class="line">    TF_ONE_WAY  = <span class="number">0x01</span>, <span class="comment">/* this is a one-way call: async, no return */</span></div><div class="line">    TF_ROOT_OBJECT  = <span class="number">0x04</span>, <span class="comment">/* contents are the component's root object */</span></div><div class="line">    TF_STATUS_CODE  = <span class="number">0x08</span>, <span class="comment">/* contents are a 32-bit status code */</span></div><div class="line">    TF_ACCEPT_FDS   = <span class="number">0x10</span>, <span class="comment">/* allow replies with file descriptors */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>而 <code>flat_binder_object</code> 中的 <code>union 联合体</code> 就是要传输的数据，当类型为 <code>BINDER</code> 时， 数据就是一个本地对象 <code>*binder</code>，而类型为 <code>HANDLE</code> 时，数据则是一个远程对象 <code>handle</code>。</p>
<p>当 <code>flat_binder_object</code> 在进程间传递时， Binder 驱动会修改它的类型和数据，交换的代码参考 <code>binder_transaction</code> 的实现。</p>
<p>该如何理解本地 <code>BINDER</code> 对象和远程 <code>HANDLE</code> 对象呢？其实它们都代表同一个对象，不过是从不同的角度来看。举例来说，假如进程 <code>RemoteService</code> 有个对象 <code>mBinder</code>，对于 <code>RemoteService</code> 来说，<code>mBinder</code> 就是一个本地的 <code>BINDER</code> 对象；如果进程 <code>app</code> 通过 <code>Binder</code> 驱动访问 <code>RemoteService</code> 的 <code>mBinder</code> 对象，对于 <code>app</code> 来说， <code>mBinder</code> 就是一个 <code>HANDLE</code>。因此，从根本上来说 <code>handle</code> 和 <code>binder</code> 都指向 <code>RemoteService</code> 的 <code>mBinder</code>。本地对象还可以带有额外的数据，保存在 <code>cookie</code> 中。</p>
<p>Binder 驱动直接操作的最外层数据结构是 <code>binder_transaction_data</code>， Binder 对象 <code>flat_binder_object</code> 被封装在 <code>binder_transaction_data</code> 结构体中。</p>
<p><code>binder_transaction_data</code> 数据结构才是真正传输的数据，其定义如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">struct binder_transaction_data &#123;</div><div class="line">    <span class="comment">/* The first two are only used for bcTRANSACTION and brTRANSACTION,</span></div><div class="line">     * identifying the target and contents of the transaction.</div><div class="line">     */</div><div class="line">    union &#123;</div><div class="line">        size_t  handle; <span class="comment">/* target descriptor of command transaction */</span></div><div class="line">        <span class="keyword">void</span>    *ptr;   <span class="comment">/* target descriptor of return transaction */</span></div><div class="line">    &#125; target;</div><div class="line">    <span class="keyword">void</span>        *cookie;    <span class="comment">/* target object cookie */</span></div><div class="line">    unsigned <span class="keyword">int</span>    code;       <span class="comment">/* transaction command */</span></div><div class="line"></div><div class="line">    <span class="comment">/* General information about the transaction. */</span></div><div class="line">    unsigned <span class="keyword">int</span>    flags;</div><div class="line">    pid_t       sender_pid;</div><div class="line">    uid_t       sender_euid;</div><div class="line">    size_t      data_size;  <span class="comment">/* number of bytes of data */</span></div><div class="line">    size_t      offsets_size;   <span class="comment">/* number of bytes of offsets */</span></div><div class="line"></div><div class="line">    <span class="comment">/* If this transaction is inline, the data immediately</span></div><div class="line">     * follows here; otherwise, it ends with a pointer to</div><div class="line">     * the data buffer.</div><div class="line">     */</div><div class="line">    union &#123;</div><div class="line">        struct &#123;</div><div class="line">            <span class="comment">/* transaction data */</span></div><div class="line">            <span class="keyword">const</span> <span class="keyword">void</span>  *buffer;</div><div class="line">            <span class="comment">/* offsets from buffer to flat_binder_object structs */</span></div><div class="line">            <span class="keyword">const</span> <span class="keyword">void</span>  *offsets;</div><div class="line">        &#125; ptr;</div><div class="line">        uint8_t buf[<span class="number">8</span>];</div><div class="line">    &#125; data;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>flat_binder_object</code> 就被封装在 <code>*buffer</code>中，其中的 <code>unsigned int code</code>; 则是传输命令，描述了 Binder 对象执行的操作。</p>
<h3 id="4-1-binder-设备的创建"><a href="#4-1-binder-设备的创建" class="headerlink" title="4.1 binder 设备的创建"></a>4.1 binder 设备的创建</h3><p><code>device_initcall()</code> 函数是内核加载驱动的入口函数，我们先来看这个函数的调用过程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> struct miscdevice binder_miscdev = &#123;</div><div class="line">    .minor = MISC_DYNAMIC_MINOR,</div><div class="line">    <span class="comment">// 设备文件 /dev/binder</span></div><div class="line">    .name = <span class="string">"binder"</span>,</div><div class="line">    <span class="comment">// 设备文件操作</span></div><div class="line">    .fops = &amp;binder_fops</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">binder_init</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 注册字符设备</span></div><div class="line">    ret = misc_register(&amp;binder_miscdev);</div><div class="line">    ...</div><div class="line">    <span class="comment">// 调试文件， 在 /sys/kernel/debug/binder 目录下</span></div><div class="line">    <span class="keyword">if</span> (binder_debugfs_dir_entry_root) &#123;</div><div class="line">        debugfs_create_file(<span class="string">"state"</span>,</div><div class="line">                    S_IRUGO,</div><div class="line">                    binder_debugfs_dir_entry_root,</div><div class="line">                    NULL,</div><div class="line">                    &amp;binder_state_fops);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line">device_initcall(binder_init);</div></pre></td></tr></table></figure>
<p>可以看出 <code>binder_init()</code> 使用 <code>misc_register()</code> 函数创建了 binder 设备。从 <code>misc_register(&amp;binder_miscdev)</code>; 及 .<code>name = &quot;binder&quot;</code> 可以看出， binder 向 kernel 注册了一个 <code>/dev/binder</code> 的字符设备，而文件操作都在 <code>binder_fops</code> 结构体中定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> struct file_operations binder_fops = &#123;</div><div class="line">    .owner = THIS_MODULE,</div><div class="line">    .poll = binder_poll,</div><div class="line">    .unlocked_ioctl = binder_ioctl,</div><div class="line">    .mmap = binder_mmap,</div><div class="line">    .open = binder_open,</div><div class="line">    .flush = binder_flush,</div><div class="line">    .release = binder_release,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>从上面 <code>binder_fops</code> 结构体可以看出，主要的操作是 <code>binder_ioctl()</code> <code>binder_mmap()</code> <code>binder_open()</code> 等函数实现的。</p>
<h3 id="4-2-binder-协议和数据结构"><a href="#4-2-binder-协议和数据结构" class="headerlink" title="4.2 binder 协议和数据结构"></a>4.2 binder 协议和数据结构</h3><p><code>binder.h</code>文件中定义了 binder 协议和重要的数据结构。</p>
<p>首先在 <code>enum</code> 中定义了 binder 处理的类型，引用或是句柄</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> &#123;</div><div class="line">    BINDER_TYPE_BINDER  = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_WEAK_BINDER = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'b'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_HANDLE  = B_PACK_CHARS(<span class="string">'s'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_WEAK_HANDLE = B_PACK_CHARS(<span class="string">'w'</span>, <span class="string">'h'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">    BINDER_TYPE_FD      = B_PACK_CHARS(<span class="string">'f'</span>, <span class="string">'d'</span>, <span class="string">'*'</span>, B_TYPE_LARGE),</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>下面这段宏定义则是在 <code>ioctl</code> 函数调用时可用的具体命令。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#define BINDER_WRITE_READ       _IOWR('b', 1, struct binder_write_read)</div><div class="line">#define BINDER_SET_IDLE_TIMEOUT     _IOW('b', 3, int64_t)</div><div class="line">#define BINDER_SET_MAX_THREADS      _IOW('b', 5, size_t)</div><div class="line">#define BINDER_SET_IDLE_PRIORITY    _IOW('b', 6, int)</div><div class="line">#define BINDER_SET_CONTEXT_MGR      _IOW('b', 7, int)</div><div class="line">#define BINDER_THREAD_EXIT      _IOW('b', 8, int)</div><div class="line">#define BINDER_VERSION          _IOWR('b', 9, struct binder_version)</div></pre></td></tr></table></figure>
<p>在 <code>BinderDriverReturnProtocol</code> 和 <code>BinderDriverCommandProtocol</code>中 则分别定义了 客户端调用 和 服务端 返回的命令。</p>
<h3 id="4-3-binder-驱动文件操作"><a href="#4-3-binder-驱动文件操作" class="headerlink" title="4.3 binder 驱动文件操作"></a>4.3 binder 驱动文件操作</h3><p>上文已经提到，所有的操作定义在 <code>binder_fops</code> 结构体中，下面讲述这些操作。</p>
<p><strong>设备的打开 - binder_open() 函数</strong></p>
<p>用户空间在打开<code>/dev/binder</code> 设备时，驱动会出发 <code>binder_open()</code> 函数的响应。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_open</span><span class="params">(struct inode *nodp, struct file *filp)</span></span></div><div class="line">&#123;</div><div class="line">    struct binder_proc *proc;</div><div class="line"></div><div class="line">    <span class="comment">// 分配 binder_proc 数据结构内存</span></div><div class="line">    proc = kzalloc(sizeof(*proc), GFP_KERNEL);</div><div class="line">    <span class="keyword">if</span> (proc == NULL)</div><div class="line">        <span class="keyword">return</span> -ENOMEM;</div><div class="line"></div><div class="line">    <span class="comment">// 增加当前线程/进程的引用计数并赋值给tsk</span></div><div class="line">    get_task_struct(current);</div><div class="line">    proc-&gt;tsk = current;</div><div class="line">    <span class="comment">// 初始化队列</span></div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;todo);</div><div class="line">    init_waitqueue_head(&amp;proc-&gt;wait);</div><div class="line">    proc-&gt;default_priority = task_nice(current);</div><div class="line"></div><div class="line">    binder_lock(__func__);</div><div class="line"></div><div class="line">    <span class="comment">// 增加BINDER_STAT_PROC的对象计数</span></div><div class="line">    binder_stats_created(BINDER_STAT_PROC);</div><div class="line">    <span class="comment">// 添加 proc_node 到 binder_procs 全局列表中，这样任何进程就可以访问到其他进程的 binder_proc 对象了</span></div><div class="line">    hlist_add_head(&amp;proc-&gt;proc_node, &amp;binder_procs);</div><div class="line">    <span class="comment">// 保存进程 id</span></div><div class="line">    proc-&gt;pid = current-&gt;group_leader-&gt;pid;</div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;delivered_death);</div><div class="line">    <span class="comment">// 驱动文件 private_data 指向 proc</span></div><div class="line">    filp-&gt;private_data = proc;</div><div class="line"></div><div class="line">    binder_unlock(__func__);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>驱动文件释放 - binder_release() 函数</strong></p>
<p>在用户空间关闭驱动设备文件时，会调用 <code>binder_release()</code> 函数，清理 binder_proc 对象，释放占用的内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_release</span><span class="params">(struct inode *nodp, struct file *filp)</span></span></div><div class="line">&#123;</div><div class="line">    struct binder_proc *proc = filp-&gt;private_data;</div><div class="line">    binder_defer_work(proc, BINDER_DEFERRED_RELEASE);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">binder_defer_work</span><span class="params">(struct binder_proc *proc, <span class="keyword">enum</span> binder_deferred_state defer)</span></div><div class="line">&#123;</div><div class="line">    mutex_lock(&amp;binder_deferred_lock);</div><div class="line">    proc-&gt;deferred_work |= defer;</div><div class="line">    <span class="keyword">if</span> (hlist_unhashed(&amp;proc-&gt;deferred_work_node)) &#123;</div><div class="line">        <span class="comment">// 添加到释放队列中</span></div><div class="line">        hlist_add_head(&amp;proc-&gt;deferred_work_node,</div><div class="line">                &amp;binder_deferred_list);</div><div class="line">        queue_work(binder_deferred_workqueue, &amp;binder_deferred_work);</div><div class="line">    &#125;</div><div class="line">    mutex_unlock(&amp;binder_deferred_lock);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>内存映射 - binder_mmap() 函数</strong></p>
<p><code>binder_mmap()</code> 函数把设备内存映射到用户进程地址空间中，这样就可以像操作用户内存那样操作设备内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_mmap</span><span class="params">(struct file *filp, struct vm_area_struct *vma)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    struct vm_struct *area;</div><div class="line">    <span class="comment">// 获得 binder_proc 对象</span></div><div class="line">    struct binder_proc *proc = filp-&gt;private_data;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *failure_string;</div><div class="line">    struct binder_buffer *buffer;</div><div class="line"></div><div class="line">    <span class="comment">// 最多只分配 4M 的内存</span></div><div class="line">    <span class="keyword">if</span> ((vma-&gt;vm_end - vma-&gt;vm_start) &gt; SZ_4M)</div><div class="line">        vma-&gt;vm_end = vma-&gt;vm_start + SZ_4M;</div><div class="line"></div><div class="line">    <span class="comment">// 检查 flags</span></div><div class="line">    <span class="keyword">if</span> (vma-&gt;vm_flags &amp; FORBIDDEN_MMAP_FLAGS) &#123;</div><div class="line">        ret = -EPERM;</div><div class="line">        failure_string = <span class="string">"bad vm_flags"</span>;</div><div class="line">        goto err_bad_arg;</div><div class="line">    &#125;</div><div class="line">    vma-&gt;vm_flags = (vma-&gt;vm_flags | VM_DONTCOPY) &amp; ~VM_MAYWRITE;</div><div class="line"></div><div class="line">    mutex_lock(&amp;binder_mmap_lock);</div><div class="line">    <span class="comment">// 检查是否已经映射</span></div><div class="line">    <span class="keyword">if</span> (proc-&gt;buffer) &#123;</div><div class="line">        ret = -EBUSY;</div><div class="line">        failure_string = <span class="string">"already mapped"</span>;</div><div class="line">        goto err_already_mapped;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 申请内核虚拟内存空间</span></div><div class="line">    area = get_vm_area(vma-&gt;vm_end - vma-&gt;vm_start, VM_IOREMAP);</div><div class="line">    <span class="keyword">if</span> (area == NULL) &#123;</div><div class="line">        ret = -ENOMEM;</div><div class="line">        failure_string = <span class="string">"get_vm_area"</span>;</div><div class="line">        goto err_get_vm_area_failed;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 将申请到的内存地址保存到 binder_proc 对象中</span></div><div class="line">    proc-&gt;buffer = area-&gt;addr;</div><div class="line">    proc-&gt;user_buffer_offset = vma-&gt;vm_start - (uintptr_t)proc-&gt;buffer;</div><div class="line">    mutex_unlock(&amp;binder_mmap_lock);</div><div class="line"></div><div class="line">    <span class="comment">// 根据请求到的内存空间大小，分配给 binder_proc 对象的 pages， 用于保存指向物理页的指针</span></div><div class="line">    proc-&gt;pages = kzalloc(sizeof(proc-&gt;pages[<span class="number">0</span>]) * ((vma-&gt;vm_end - vma-&gt;vm_start) / PAGE_SIZE), GFP_KERNEL);</div><div class="line">    <span class="keyword">if</span> (proc-&gt;pages == NULL) &#123;</div><div class="line">        ret = -ENOMEM;</div><div class="line">        failure_string = <span class="string">"alloc page array"</span>;</div><div class="line">        goto err_alloc_pages_failed;</div><div class="line">    &#125;</div><div class="line">    proc-&gt;buffer_size = vma-&gt;vm_end - vma-&gt;vm_start;</div><div class="line"></div><div class="line">    vma-&gt;vm_ops = &amp;binder_vm_ops;</div><div class="line">    vma-&gt;vm_private_data = proc;</div><div class="line"></div><div class="line">    <span class="comment">// 分配一个页的物理内存</span></div><div class="line">    <span class="keyword">if</span> (binder_update_page_range(proc, <span class="number">1</span>, proc-&gt;buffer, proc-&gt;buffer + PAGE_SIZE, vma)) &#123;</div><div class="line">        ret = -ENOMEM;</div><div class="line">        failure_string = <span class="string">"alloc small buf"</span>;</div><div class="line">        goto err_alloc_small_buf_failed;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 内存提供给 binder_buffer</span></div><div class="line">    buffer = proc-&gt;buffer;</div><div class="line">    <span class="comment">// 初始化 proc-&gt;buffers 链表</span></div><div class="line">    INIT_LIST_HEAD(&amp;proc-&gt;buffers);</div><div class="line">    <span class="comment">// 将 binder_buffer 对象放入到 proc-&gt;buffers 链表中</span></div><div class="line">    list_add(&amp;buffer-&gt;entry, &amp;proc-&gt;buffers);</div><div class="line">    buffer-&gt;free = <span class="number">1</span>;</div><div class="line">    binder_insert_free_buffer(proc, buffer);</div><div class="line">    proc-&gt;free_async_space = proc-&gt;buffer_size / <span class="number">2</span>;</div><div class="line">    barrier();</div><div class="line">    proc-&gt;files = get_files_struct(proc-&gt;tsk);</div><div class="line">    proc-&gt;vma = vma;</div><div class="line">    proc-&gt;vma_vm_mm = vma-&gt;vm_mm;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>驱动命令接口 - binder_ioctl() 函数</strong></p>
<p>用户态程序调用 <code>ioctl</code> 系统函数向 <code>/dev/binder</code>设备发送数据时，会触发 <code>binder_ioctl()</code> 函数响应。</p>
<p>上文数据结构中已经提到了 <code>binder_ioctl</code> 可以处理的 <code>命令</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// 核心命令，数据的读写</div><div class="line">#define BINDER_WRITE_READ       _IOWR('b', 1, struct binder_write_read)</div><div class="line">// 设置最大线程数</div><div class="line">#define BINDER_SET_MAX_THREADS      _IOW('b', 5, size_t)</div><div class="line">// 设置 context manager</div><div class="line">#define BINDER_SET_CONTEXT_MGR      _IOW('b', 7, int)</div><div class="line">// 线程退出命令</div><div class="line">#define BINDER_THREAD_EXIT      _IOW('b', 8, int)</div><div class="line">// binder 驱动的版本</div><div class="line">#define BINDER_VERSION          _IOWR('b', 9, struct binder_version)</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">binder_ioctl</span><span class="params">(struct file *filp, unsigned <span class="keyword">int</span> cmd, unsigned <span class="keyword">long</span> arg)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    struct binder_proc *proc = filp-&gt;private_data;</div><div class="line">    struct binder_thread *thread;</div><div class="line">    unsigned <span class="keyword">int</span> size = _IOC_SIZE(cmd);</div><div class="line">    <span class="keyword">void</span> __user *ubuf = (<span class="keyword">void</span> __user *)arg;</div><div class="line"></div><div class="line">    <span class="comment">// 检查是否有错误</span></div><div class="line">    ret = wait_event_interruptible(binder_user_error_wait, binder_stop_on_user_error &lt; <span class="number">2</span>);</div><div class="line">    <span class="keyword">if</span> (ret)</div><div class="line">        goto err_unlocked;</div><div class="line"></div><div class="line">    binder_lock(__func__);</div><div class="line">    <span class="comment">// 获取 binder_thread 对象</span></div><div class="line">    thread = binder_get_thread(proc);</div><div class="line">    <span class="keyword">if</span> (thread == NULL) &#123;</div><div class="line">        ret = -ENOMEM;</div><div class="line">        goto err;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">switch</span> (cmd) &#123;</div><div class="line">    <span class="keyword">case</span> BINDER_WRITE_READ: &#123;</div><div class="line">        struct binder_write_read bwr;</div><div class="line">        <span class="keyword">if</span> (size != sizeof(struct binder_write_read)) &#123;</div><div class="line">            ret = -EINVAL;</div><div class="line">            goto err;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 从用户空间拷贝 binder_write_read 到 binder 驱动，储存在 bwr</span></div><div class="line">        <span class="keyword">if</span> (copy_from_user(&amp;bwr, ubuf, sizeof(bwr))) &#123;</div><div class="line">            ret = -EFAULT;</div><div class="line">            goto err;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (bwr.write_size &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 执行写入操作</span></div><div class="line">            ret = binder_thread_write(proc, thread, (<span class="keyword">void</span> __user *)bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">                bwr.read_consumed = <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, sizeof(bwr)))</div><div class="line">                    ret = -EFAULT;</div><div class="line">                goto err;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (bwr.read_size &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 执行读取操作</span></div><div class="line">            ret = binder_thread_read(proc, thread, (<span class="keyword">void</span> __user *)bwr.read_buffer, bwr.read_size, &amp;bwr.read_consumed, filp-&gt;f_flags &amp; O_NONBLOCK);</div><div class="line">            <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo))</div><div class="line">                wake_up_interruptible(&amp;proc-&gt;wait);</div><div class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, sizeof(bwr)))</div><div class="line">                    ret = -EFAULT;</div><div class="line">                goto err;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 操作完成后将数据返回给用户空间</span></div><div class="line">        <span class="keyword">if</span> (copy_to_user(ubuf, &amp;bwr, sizeof(bwr))) &#123;</div><div class="line">            ret = -EFAULT;</div><div class="line">            goto err;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> BINDER_SET_MAX_THREADS:</div><div class="line">        <span class="comment">// 设置最大线程，从用户空间拷贝数据到 proc-&gt;max_threads</span></div><div class="line">        <span class="keyword">if</span> (copy_from_user(&amp;proc-&gt;max_threads, ubuf, sizeof(proc-&gt;max_threads))) &#123;</div><div class="line">            ret = -EINVAL;</div><div class="line">            goto err;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> BINDER_SET_CONTEXT_MGR:</div><div class="line">        <span class="comment">// 检查是否已经设置</span></div><div class="line">        <span class="keyword">if</span> (binder_context_mgr_node != NULL) &#123;</div><div class="line">            ret = -EBUSY;</div><div class="line">            goto err;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 设置 context manager</span></div><div class="line">        ret = security_binder_set_context_mgr(proc-&gt;tsk);</div><div class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</div><div class="line">            goto err;</div><div class="line">        <span class="keyword">if</span> (binder_context_mgr_uid != -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (binder_context_mgr_uid != current-&gt;cred-&gt;euid) &#123;</div><div class="line">                ret = -EPERM;</div><div class="line">                goto err;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            binder_context_mgr_uid = current-&gt;cred-&gt;euid;</div><div class="line">        <span class="comment">// 创建 binder_context_mgr_node 节点</span></div><div class="line">        binder_context_mgr_node = binder_new_node(proc, NULL, NULL);</div><div class="line">        <span class="keyword">if</span> (binder_context_mgr_node == NULL) &#123;</div><div class="line">            ret = -ENOMEM;</div><div class="line">            goto err;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 初始化节点数据</span></div><div class="line">        binder_context_mgr_node-&gt;local_weak_refs++;</div><div class="line">        binder_context_mgr_node-&gt;local_strong_refs++;</div><div class="line">        binder_context_mgr_node-&gt;has_strong_ref = <span class="number">1</span>;</div><div class="line">        binder_context_mgr_node-&gt;has_weak_ref = <span class="number">1</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> BINDER_THREAD_EXIT:</div><div class="line">        <span class="comment">// 线程退出，释放资源</span></div><div class="line">        binder_free_thread(proc, thread);</div><div class="line">        thread = NULL;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> BINDER_VERSION:</div><div class="line">        <span class="comment">// 将 binder 驱动版本号写入到用户空间 ubuf-&gt;protocol_version 中</span></div><div class="line">        <span class="keyword">if</span> (put_user(BINDER_CURRENT_PROTOCOL_VERSION, &amp;((struct binder_version *)ubuf)-&gt;protocol_version)) &#123;</div><div class="line">            ret = -EINVAL;</div><div class="line">            goto err;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        ret = -EINVAL;</div><div class="line">        goto err;</div><div class="line">    &#125;</div><div class="line">    ret = <span class="number">0</span>;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> struct binder_node *binder_new_node(struct binder_proc *proc,</div><div class="line">                       <span class="keyword">void</span> __user *ptr,</div><div class="line">                       <span class="keyword">void</span> __user *cookie)</div><div class="line">&#123;</div><div class="line">    struct rb_node **p = &amp;proc-&gt;nodes.rb_node;</div><div class="line">    struct rb_node *parent = NULL;</div><div class="line">    struct binder_node *node;</div><div class="line"></div><div class="line">    <span class="comment">// 查找要插入节点的父节点</span></div><div class="line">    <span class="keyword">while</span> (*p) &#123;</div><div class="line">        parent = *p;</div><div class="line">        node = rb_entry(parent, struct binder_node, rb_node);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ptr &lt; node-&gt;ptr)</div><div class="line">            p = &amp;(*p)-&gt;rb_left;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ptr &gt; node-&gt;ptr)</div><div class="line">            p = &amp;(*p)-&gt;rb_right;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 为要插入节点分配内存空间</span></div><div class="line">    node = kzalloc(sizeof(*node), GFP_KERNEL);</div><div class="line">    <span class="keyword">if</span> (node == NULL)</div><div class="line">        <span class="keyword">return</span> NULL;</div><div class="line">    binder_stats_created(BINDER_STAT_NODE);</div><div class="line">    <span class="comment">// 插入节点</span></div><div class="line">    rb_link_node(&amp;node-&gt;rb_node, parent, p);</div><div class="line">    rb_insert_color(&amp;node-&gt;rb_node, &amp;proc-&gt;nodes);</div><div class="line">    <span class="comment">// 初始化</span></div><div class="line">    node-&gt;debug_id = ++binder_last_id;</div><div class="line">    node-&gt;proc = proc;</div><div class="line">    node-&gt;ptr = ptr;</div><div class="line">    node-&gt;cookie = cookie;</div><div class="line">    node-&gt;work.type = BINDER_WORK_NODE;</div><div class="line">    INIT_LIST_HEAD(&amp;node-&gt;work.entry);</div><div class="line">    INIT_LIST_HEAD(&amp;node-&gt;async_todo);</div><div class="line">    <span class="keyword">return</span> node;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>BINDER_WRITE_READ 处理过程</strong></p>
<p>在 binder 本地层中，我们看到在 <code>IPCThreadState::talkWithDriver()</code> 函数中， binder 本地层通过 <code>ioctl()(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr)</code> 命令的形式，与 binder 驱动交互。</p>
<p>可以看出<code>ioctl()</code>的第三个参数是一个 <code>binder_write_read</code> 结构体</p>
<p>binder.h 头文件中定义了两个数据类型, 一个是 <code>binder_write_read</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">struct binder_write_read &#123;</div><div class="line">    signed <span class="keyword">long</span> write_size; <span class="comment">/* bytes to write */</span></div><div class="line">    signed <span class="keyword">long</span> write_consumed; <span class="comment">/* bytes consumed by driver */</span></div><div class="line">    unsigned <span class="keyword">long</span>   write_buffer;</div><div class="line">    signed <span class="keyword">long</span> read_size;  <span class="comment">/* bytes to read */</span></div><div class="line">    signed <span class="keyword">long</span> read_consumed;  <span class="comment">/* bytes consumed by driver */</span></div><div class="line">    unsigned <span class="keyword">long</span>   read_buffer;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中 <code>write_size</code> 和 <code>read_size</code> 表示需要被读写的字节数， <code>write_consumed</code> 和 <code>read_consumed</code> 表示已经被 binder 驱动读写的字节数， <code>write_buffer</code> 和 <code>read_buffer</code> 则是指向被读写数据的指针。</p>
<p>具体的读写操作被 <code>binder_thread_write</code> 和 <code>binder_thread_read</code> 实现。</p>
<p><strong>数据写入 - binder_thread_write() 函数</strong></p>
<p>将用户空间数据写入到 binder 驱动，从驱动角度来看是读取的操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc, struct binder_thread *thread,</span></span></div><div class="line">            <span class="keyword">void</span> __user *buffer, <span class="keyword">int</span> size, signed <span class="keyword">long</span> *consumed)</div><div class="line">&#123;</div><div class="line">    uint32_t cmd;</div><div class="line">    <span class="comment">// 用户空间数据，起始地址和结束地址</span></div><div class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</div><div class="line">    <span class="keyword">void</span> __user *end = buffer + size;</div><div class="line"></div><div class="line">    <span class="comment">// 循环读取</span></div><div class="line">    <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;</div><div class="line">        <span class="comment">// 从用户空间获取操作命令</span></div><div class="line">        <span class="keyword">if</span> (get_user(cmd, (uint32_t __user *)ptr))</div><div class="line">            <span class="keyword">return</span> -EFAULT;</div><div class="line">        ptr += sizeof(uint32_t);</div><div class="line">        <span class="keyword">if</span> (_IOC_NR(cmd) &lt; ARRAY_SIZE(binder_stats.bc)) &#123;</div><div class="line">            <span class="comment">// 增加命令计数器</span></div><div class="line">            binder_stats.bc[_IOC_NR(cmd)]++;</div><div class="line">            proc-&gt;stats.bc[_IOC_NR(cmd)]++;</div><div class="line">            thread-&gt;stats.bc[_IOC_NR(cmd)]++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">switch</span> (cmd) &#123;</div><div class="line">        <span class="comment">// 这四个命令用来增加或减少对象的引用计数， 操作目标 binder_ref</span></div><div class="line">        <span class="keyword">case</span> BC_INCREFS:</div><div class="line">        <span class="keyword">case</span> BC_ACQUIRE:</div><div class="line">        <span class="keyword">case</span> BC_RELEASE:</div><div class="line">        <span class="keyword">case</span> BC_DECREFS: &#123;</div><div class="line">            uint32_t target;</div><div class="line">            struct binder_ref *ref;</div><div class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *debug_string;</div><div class="line"></div><div class="line">            <span class="comment">// 获取目标进程节点描述 desc</span></div><div class="line">            <span class="keyword">if</span> (get_user(target, (uint32_t __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(uint32_t);</div><div class="line">            <span class="comment">// 索描述为 0 表示 context manager 进程</span></div><div class="line">            <span class="keyword">if</span> (target == <span class="number">0</span> &amp;&amp; binder_context_mgr_node &amp;&amp;</div><div class="line">                (cmd == BC_INCREFS || cmd == BC_ACQUIRE)) &#123;</div><div class="line">                <span class="comment">// 在 proc-&gt;refs_by_node.rb_node 红黑树中查找引用</span></div><div class="line">                ref = binder_get_ref_for_node(proc,</div><div class="line">                           binder_context_mgr_node);</div><div class="line">            &#125; <span class="keyword">else</span></div><div class="line">                <span class="comment">// 在 proc-&gt;refs_by_desc.rb_node 红黑树中查找引用</span></div><div class="line">                ref = binder_get_ref(proc, target);</div><div class="line">            <span class="keyword">switch</span> (cmd) &#123;</div><div class="line">            <span class="keyword">case</span> BC_INCREFS:</div><div class="line">                debug_string = <span class="string">"IncRefs"</span>;</div><div class="line">                <span class="comment">// 增加弱引用计数</span></div><div class="line">                binder_inc_ref(ref, <span class="number">0</span>, NULL);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BC_ACQUIRE:</div><div class="line">                debug_string = <span class="string">"Acquire"</span>;</div><div class="line">                <span class="comment">// 增加强引用计数</span></div><div class="line">                binder_inc_ref(ref, <span class="number">1</span>, NULL);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BC_RELEASE:</div><div class="line">                debug_string = <span class="string">"Release"</span>;</div><div class="line">                <span class="comment">// 减少强引用计数</span></div><div class="line">                binder_dec_ref(ref, <span class="number">1</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> BC_DECREFS:</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                debug_string = <span class="string">"DecRefs"</span>;</div><div class="line">                <span class="comment">// 减少弱引用计数</span></div><div class="line">                binder_dec_ref(ref, <span class="number">0</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">case</span> BC_INCREFS_DONE:</div><div class="line">        <span class="keyword">case</span> BC_ACQUIRE_DONE: &#123;</div><div class="line">            <span class="keyword">void</span> __user *node_ptr;</div><div class="line">            <span class="keyword">void</span> *cookie;</div><div class="line">            struct binder_node *node;</div><div class="line"></div><div class="line">            <span class="comment">// 从用户空间读取 node_ptr</span></div><div class="line">            <span class="keyword">if</span> (get_user(node_ptr, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(<span class="keyword">void</span> *);</div><div class="line">            <span class="comment">// 从用户空间读取 cookie</span></div><div class="line">            <span class="keyword">if</span> (get_user(cookie, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(<span class="keyword">void</span> *);</div><div class="line">            <span class="comment">// 获得节点</span></div><div class="line">            node = binder_get_node(proc, node_ptr);</div><div class="line">            <span class="comment">// 没有找到则返回</span></div><div class="line">            <span class="keyword">if</span> (node == NULL) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d "</span></div><div class="line">                    <span class="string">"%s u%p no match\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid,</div><div class="line">                    cmd == BC_INCREFS_DONE ?</div><div class="line">                    <span class="string">"BC_INCREFS_DONE"</span> :</div><div class="line">                    <span class="string">"BC_ACQUIRE_DONE"</span>,</div><div class="line">                    node_ptr);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// cookie 不匹配则返回</span></div><div class="line">            <span class="keyword">if</span> (cookie != node-&gt;cookie) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d %s u%p node %d"</span></div><div class="line">                    <span class="string">" cookie mismatch %p != %p\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid,</div><div class="line">                    cmd == BC_INCREFS_DONE ?</div><div class="line">                    <span class="string">"BC_INCREFS_DONE"</span> : <span class="string">"BC_ACQUIRE_DONE"</span>,</div><div class="line">                    node_ptr, node-&gt;debug_id,</div><div class="line">                    cookie, node-&gt;cookie);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (cmd == BC_ACQUIRE_DONE) &#123;</div><div class="line">                node-&gt;pending_strong_ref = <span class="number">0</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                node-&gt;pending_weak_ref = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 减少节点使用计数</span></div><div class="line">            binder_dec_node(node, cmd == BC_ACQUIRE_DONE, <span class="number">0</span>);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 释放 binder_bffer</span></div><div class="line">        <span class="keyword">case</span> BC_FREE_BUFFER: &#123;</div><div class="line">            <span class="keyword">void</span> __user *data_ptr;</div><div class="line">            struct binder_buffer *buffer;</div><div class="line"></div><div class="line">            <span class="comment">// 从用户空间获取 data_ptr</span></div><div class="line">            <span class="keyword">if</span> (get_user(data_ptr, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(<span class="keyword">void</span> *);</div><div class="line"></div><div class="line">            <span class="comment">// 查找 binder_buffer</span></div><div class="line">            buffer = binder_buffer_lookup(proc, data_ptr);</div><div class="line">            <span class="comment">// 没有找到则返回</span></div><div class="line">            <span class="keyword">if</span> (buffer == NULL) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d "</span></div><div class="line">                    <span class="string">"BC_FREE_BUFFER u%p no match\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid, data_ptr);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 不允许用户释放则返回</span></div><div class="line">            <span class="keyword">if</span> (!buffer-&gt;allow_user_free) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d "</span></div><div class="line">                    <span class="string">"BC_FREE_BUFFER u%p matched "</span></div><div class="line">                    <span class="string">"unreturned buffer\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid, data_ptr);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// 将 buffer-&gt;transaction 置空</span></div><div class="line">            <span class="keyword">if</span> (buffer-&gt;transaction) &#123;</div><div class="line">                buffer-&gt;transaction-&gt;buffer = NULL;</div><div class="line">                buffer-&gt;transaction = NULL;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (buffer-&gt;async_transaction &amp;&amp; buffer-&gt;target_node) &#123;</div><div class="line">                <span class="keyword">if</span> (list_empty(&amp;buffer-&gt;target_node-&gt;async_todo))</div><div class="line">                    buffer-&gt;target_node-&gt;has_async_transaction = <span class="number">0</span>;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    list_move_tail(buffer-&gt;target_node-&gt;async_todo.next, &amp;thread-&gt;todo);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 释放 binder_buffer 对象</span></div><div class="line">            trace_binder_transaction_buffer_release(buffer);</div><div class="line">            binder_transaction_buffer_release(proc, buffer, NULL);</div><div class="line">            binder_free_buf(proc, buffer);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// binder 数据传递处理</span></div><div class="line">        <span class="keyword">case</span> BC_TRANSACTION:</div><div class="line">        <span class="keyword">case</span> BC_REPLY: &#123;</div><div class="line">            struct binder_transaction_data tr;</div><div class="line"></div><div class="line">            <span class="comment">// 从用户空间拷贝 binder_transaction_data 对象</span></div><div class="line">            <span class="keyword">if</span> (copy_from_user(&amp;tr, ptr, sizeof(tr)))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(tr);</div><div class="line">            <span class="comment">// 实际的传输函数，在下文讲解</span></div><div class="line">            binder_transaction(proc, thread, &amp;tr, cmd == BC_REPLY);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 设置 looper 为 BINDER_LOOPER_STATE_REGISTERED 状态</span></div><div class="line">        <span class="keyword">case</span> BC_REGISTER_LOOPER:</div><div class="line">            <span class="keyword">if</span> (thread-&gt;looper &amp; BINDER_LOOPER_STATE_ENTERED) &#123;</div><div class="line">                thread-&gt;looper |= BINDER_LOOPER_STATE_INVALID;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d ERROR:"</span></div><div class="line">                    <span class="string">" BC_REGISTER_LOOPER called "</span></div><div class="line">                    <span class="string">"after BC_ENTER_LOOPER\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proc-&gt;requested_threads == <span class="number">0</span>) &#123;</div><div class="line">                thread-&gt;looper |= BINDER_LOOPER_STATE_INVALID;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d ERROR:"</span></div><div class="line">                    <span class="string">" BC_REGISTER_LOOPER called "</span></div><div class="line">                    <span class="string">"without request\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                proc-&gt;requested_threads--;</div><div class="line">                proc-&gt;requested_threads_started++;</div><div class="line">            &#125;</div><div class="line">            thread-&gt;looper |= BINDER_LOOPER_STATE_REGISTERED;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="comment">// 设置 looper 为 BINDER_LOOPER_STATE_ENTERED 状态</span></div><div class="line">        <span class="keyword">case</span> BC_ENTER_LOOPER:</div><div class="line">            <span class="keyword">if</span> (thread-&gt;looper &amp; BINDER_LOOPER_STATE_REGISTERED) &#123;</div><div class="line">                thread-&gt;looper |= BINDER_LOOPER_STATE_INVALID;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d ERROR:"</span></div><div class="line">                    <span class="string">" BC_ENTER_LOOPER called after "</span></div><div class="line">                    <span class="string">"BC_REGISTER_LOOPER\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid);</div><div class="line">            &#125;</div><div class="line">            thread-&gt;looper |= BINDER_LOOPER_STATE_ENTERED;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="comment">// 设置 looper 为 BINDER_LOOPER_STATE_EXITED 状态</span></div><div class="line">        <span class="keyword">case</span> BC_EXIT_LOOPER:</div><div class="line">            thread-&gt;looper |= BINDER_LOOPER_STATE_EXITED;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 发送 REQUEST_DEATH 或 CLEAR_DEATH 通知</span></div><div class="line">        <span class="keyword">case</span> BC_REQUEST_DEATH_NOTIFICATION:</div><div class="line">        <span class="keyword">case</span> BC_CLEAR_DEATH_NOTIFICATION: &#123;</div><div class="line">            uint32_t target;</div><div class="line">            <span class="keyword">void</span> __user *cookie;</div><div class="line">            struct binder_ref *ref;</div><div class="line">            struct binder_ref_death *death;</div><div class="line"></div><div class="line">            <span class="comment">// 从用户空间获取 binder_ref 描述 desc</span></div><div class="line">            <span class="keyword">if</span> (get_user(target, (uint32_t __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(uint32_t);</div><div class="line">            <span class="comment">// 从用户空间获取 cookie</span></div><div class="line">            <span class="keyword">if</span> (get_user(cookie, (<span class="keyword">void</span> __user * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(<span class="keyword">void</span> *);</div><div class="line">            <span class="comment">// 获取 binder_ref 引用</span></div><div class="line">            ref = binder_get_ref(proc, target);</div><div class="line">            <span class="keyword">if</span> (ref == NULL) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d %s "</span></div><div class="line">                    <span class="string">"invalid ref %d\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid,</div><div class="line">                    cmd == BC_REQUEST_DEATH_NOTIFICATION ?</div><div class="line">                    <span class="string">"BC_REQUEST_DEATH_NOTIFICATION"</span> :</div><div class="line">                    <span class="string">"BC_CLEAR_DEATH_NOTIFICATION"</span>,</div><div class="line">                    target);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (cmd == BC_REQUEST_DEATH_NOTIFICATION) &#123;</div><div class="line">                <span class="keyword">if</span> (ref-&gt;death) &#123;</div><div class="line">                    binder_user_error(<span class="string">"binder: %d:%"</span></div><div class="line">                        <span class="string">"d BC_REQUEST_DEATH_NOTI"</span></div><div class="line">                        <span class="string">"FICATION death notific"</span></div><div class="line">                        <span class="string">"ation already set\n"</span>,</div><div class="line">                        proc-&gt;pid, thread-&gt;pid);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 为 binder_ref_death 对象分配内存空间</span></div><div class="line">                death = kzalloc(sizeof(*death), GFP_KERNEL);</div><div class="line">                <span class="keyword">if</span> (death == NULL) &#123;</div><div class="line">                    thread-&gt;return_error = BR_ERROR;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 初始化 binder_ref_death 对象</span></div><div class="line">                binder_stats_created(BINDER_STAT_DEATH);</div><div class="line">                INIT_LIST_HEAD(&amp;death-&gt;work.entry);</div><div class="line">                death-&gt;cookie = cookie;</div><div class="line">                ref-&gt;death = death;</div><div class="line">                <span class="keyword">if</span> (ref-&gt;node-&gt;proc == NULL) &#123;</div><div class="line">                    ref-&gt;death-&gt;work.type = BINDER_WORK_DEAD_BINDER;</div><div class="line">                    <span class="keyword">if</span> (thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED | BINDER_LOOPER_STATE_ENTERED)) &#123;</div><div class="line">                        list_add_tail(&amp;ref-&gt;death-&gt;work.entry, &amp;thread-&gt;todo);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        list_add_tail(&amp;ref-&gt;death-&gt;work.entry, &amp;proc-&gt;todo);</div><div class="line">                        <span class="comment">// 唤醒目标进程</span></div><div class="line">                        wake_up_interruptible(&amp;proc-&gt;wait);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (ref-&gt;death == NULL) &#123;</div><div class="line">                    binder_user_error(<span class="string">"binder: %d:%"</span></div><div class="line">                        <span class="string">"d BC_CLEAR_DEATH_NOTIFI"</span></div><div class="line">                        <span class="string">"CATION death notificat"</span></div><div class="line">                        <span class="string">"ion not active\n"</span>,</div><div class="line">                        proc-&gt;pid, thread-&gt;pid);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                death = ref-&gt;death;</div><div class="line">                <span class="keyword">if</span> (death-&gt;cookie != cookie) &#123;</div><div class="line">                    binder_user_error(<span class="string">"binder: %d:%"</span></div><div class="line">                        <span class="string">"d BC_CLEAR_DEATH_NOTIFI"</span></div><div class="line">                        <span class="string">"CATION death notificat"</span></div><div class="line">                        <span class="string">"ion cookie mismatch "</span></div><div class="line">                        <span class="string">"%p != %p\n"</span>,</div><div class="line">                        proc-&gt;pid, thread-&gt;pid,</div><div class="line">                        death-&gt;cookie, cookie);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 将 ref-&gt;death 置空</span></div><div class="line">                ref-&gt;death = NULL;</div><div class="line">                <span class="keyword">if</span> (list_empty(&amp;death-&gt;work.entry)) &#123;</div><div class="line">                    death-&gt;work.type = BINDER_WORK_CLEAR_DEATH_NOTIFICATION;</div><div class="line">                    <span class="keyword">if</span> (thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED | BINDER_LOOPER_STATE_ENTERED)) &#123;</div><div class="line">                        list_add_tail(&amp;death-&gt;work.entry, &amp;thread-&gt;todo);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        list_add_tail(&amp;death-&gt;work.entry, &amp;proc-&gt;todo);</div><div class="line">                        <span class="comment">// 唤醒目标进程</span></div><div class="line">                        wake_up_interruptible(&amp;proc-&gt;wait);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    BUG_ON(death-&gt;work.type != BINDER_WORK_DEAD_BINDER);</div><div class="line">                    death-&gt;work.type = BINDER_WORK_DEAD_BINDER_AND_CLEAR;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BC_DEAD_BINDER_DONE: &#123;</div><div class="line">            struct binder_work *w;</div><div class="line">            <span class="keyword">void</span> __user *cookie;</div><div class="line">            struct binder_ref_death *death = NULL;</div><div class="line">            <span class="comment">// 从用户空间获取 cookie</span></div><div class="line">            <span class="keyword">if</span> (get_user(cookie, (<span class="keyword">void</span> __user * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line"></div><div class="line">            ptr += sizeof(<span class="keyword">void</span> *);</div><div class="line">            list_for_each_entry(w, &amp;proc-&gt;delivered_death, entry) &#123;</div><div class="line">                struct binder_ref_death *tmp_death = container_of(w, struct binder_ref_death, work);</div><div class="line">                <span class="keyword">if</span> (tmp_death-&gt;cookie == cookie) &#123;</div><div class="line">                    death = tmp_death;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (death == NULL) &#123;</div><div class="line">                binder_user_error(<span class="string">"binder: %d:%d BC_DEAD"</span></div><div class="line">                    <span class="string">"_BINDER_DONE %p not found\n"</span>,</div><div class="line">                    proc-&gt;pid, thread-&gt;pid, cookie);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            list_del_init(&amp;death-&gt;work.entry);</div><div class="line">            <span class="comment">// 如果 death-&gt;work.t 为 BINDER_WORK_DEAD_BINDER_AND_CLEAR 则修改为 BINDER_WORK_CLEAR_DEATH_NOTIFICATION</span></div><div class="line">            <span class="keyword">if</span> (death-&gt;work.t == BINDER_WORK_DEAD_BINDER_AND_CLEAR ) &#123;</div><div class="line">                death-&gt;work.type = BINDER_WORK_CLEAR_DEATH_NOTIFICATION;</div><div class="line">                <span class="keyword">if</span> (thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED | BINDER_LOOPER_STATE_ENTERED)) &#123;</div><div class="line">                    list_add_tail(&amp;death-&gt;work.entry, &amp;thread-&gt;todo);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    list_add_tail(&amp;death-&gt;work.entry, &amp;proc-&gt;todo);</div><div class="line">                    <span class="comment">// 唤醒目标进程</span></div><div class="line">                    wake_up_interruptible(&amp;proc-&gt;wait);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="keyword">return</span> -EINVAL;</div><div class="line">        &#125;</div><div class="line">        *consumed = ptr - buffer;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>binder_transaction() 函数</strong></p>
<p>在上文处理 <code>BC_TRANSACTION</code> 和 <code>BC_REPLY</code> 时，调用了 <code>binder_transaction()</code> 函数。我们继续追踪</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_transaction</span><span class="params">(struct binder_proc *proc,</span></span></div><div class="line">                   struct binder_thread *thread,</div><div class="line">                   struct binder_transaction_data *tr, <span class="keyword">int</span> reply)</div><div class="line">&#123;</div><div class="line">    struct binder_transaction *t;</div><div class="line">    struct binder_work *tcomplete;</div><div class="line">    size_t *offp, *off_end;</div><div class="line">    struct binder_proc *target_proc;</div><div class="line">    struct binder_thread *target_thread = NULL;</div><div class="line">    struct binder_node *target_node = NULL;</div><div class="line">    struct list_head *target_list;</div><div class="line">    wait_queue_head_t *target_wait;</div><div class="line">    struct binder_transaction *in_reply_to = NULL;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (reply) &#123;</div><div class="line">        <span class="comment">// BC_REPLY 处理流程</span></div><div class="line">        <span class="comment">// 得到 binder_transaction 对象</span></div><div class="line">        in_reply_to = thread-&gt;transaction_stack;</div><div class="line">        <span class="keyword">if</span> (in_reply_to == NULL) &#123;</div><div class="line">            return_error = BR_FAILED_REPLY;</div><div class="line">            goto err_empty_call_stack;</div><div class="line">        &#125;</div><div class="line">        binder_set_nice(in_reply_to-&gt;saved_priority);</div><div class="line">        thread-&gt;transaction_stack = in_reply_to-&gt;to_parent;</div><div class="line">        <span class="comment">// 获取目标线程</span></div><div class="line">        target_thread = in_reply_to-&gt;from;</div><div class="line">        target_proc = target_thread-&gt;proc;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// BC_TRANSACTION 处理流程</span></div><div class="line">        <span class="comment">// 查找目标节点</span></div><div class="line">        <span class="keyword">if</span> (tr-&gt;target.handle) &#123;</div><div class="line">            struct binder_ref *ref;</div><div class="line">            <span class="comment">// 获取 binder_ref 对象</span></div><div class="line">            ref = binder_get_ref(proc, tr-&gt;target.handle);</div><div class="line">            target_node = ref-&gt;node;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 索引为 0 则返回 context manager</span></div><div class="line">            target_node = binder_context_mgr_node;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 得到目标进程</span></div><div class="line">        target_proc = target_node-&gt;proc;</div><div class="line">        <span class="keyword">if</span> (!(tr-&gt;flags &amp; TF_ONE_WAY) &amp;&amp; thread-&gt;transaction_stack) &#123;</div><div class="line">            struct binder_transaction *tmp;</div><div class="line">            tmp = thread-&gt;transaction_stack;</div><div class="line">            <span class="keyword">while</span> (tmp) &#123;</div><div class="line">                <span class="keyword">if</span> (tmp-&gt;from &amp;&amp; tmp-&gt;from-&gt;proc == target_proc)</div><div class="line">                    <span class="comment">// 获得目标线程</span></div><div class="line">                    target_thread = tmp-&gt;from;</div><div class="line">                tmp = tmp-&gt;from_parent;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 设置要处理的目标进程或目标线程任务</span></div><div class="line">    <span class="keyword">if</span> (target_thread) &#123;</div><div class="line">        target_list = &amp;target_thread-&gt;todo;</div><div class="line">        target_wait = &amp;target_thread-&gt;wait;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        target_list = &amp;target_proc-&gt;todo;</div><div class="line">        target_wait = &amp;target_proc-&gt;wait;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 为 binder_transaction 对象分配内存空间</span></div><div class="line">    t = kzalloc(sizeof(*t), GFP_KERNEL);</div><div class="line">    binder_stats_created(BINDER_STAT_TRANSACTION);</div><div class="line"></div><div class="line">    tcomplete = kzalloc(sizeof(*tcomplete), GFP_KERNEL);</div><div class="line">    binder_stats_created(BINDER_STAT_TRANSACTION_COMPLETE);</div><div class="line"></div><div class="line">    <span class="comment">// 如果是同步传输(双向)，则将当前的 binder_thread 对象保存在 binder_transaction 对象的 from 中。</span></div><div class="line">    <span class="keyword">if</span> (!reply &amp;&amp; !(tr-&gt;flags &amp; TF_ONE_WAY))</div><div class="line">        t-&gt;from = thread;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        t-&gt;from = NULL;</div><div class="line">    <span class="comment">// 设置 binder_transaction 对象</span></div><div class="line">    t-&gt;sender_euid = proc-&gt;tsk-&gt;cred-&gt;euid;</div><div class="line">    t-&gt;to_proc = target_proc;</div><div class="line">    t-&gt;to_thread = target_thread;</div><div class="line">    t-&gt;code = tr-&gt;code;</div><div class="line">    t-&gt;flags = tr-&gt;flags;</div><div class="line">    t-&gt;priority = task_nice(current);</div><div class="line"></div><div class="line">    <span class="comment">// 为 binder_buffer 分配内存空间</span></div><div class="line">    t-&gt;buffer = binder_alloc_buf(target_proc, tr-&gt;data_size,</div><div class="line">        tr-&gt;offsets_size, !reply &amp;&amp; (t-&gt;flags &amp; TF_ONE_WAY));</div><div class="line">    <span class="comment">// 设置 binder_buffer</span></div><div class="line">    t-&gt;buffer-&gt;allow_user_free = <span class="number">0</span>;</div><div class="line">    t-&gt;buffer-&gt;debug_id = t-&gt;debug_id;</div><div class="line">    t-&gt;buffer-&gt;transaction = t;</div><div class="line">    t-&gt;buffer-&gt;target_node = target_node;</div><div class="line">    <span class="keyword">if</span> (target_node)</div><div class="line">        binder_inc_node(target_node, <span class="number">1</span>, <span class="number">0</span>, NULL);</div><div class="line"></div><div class="line">    offp = (size_t *)(t-&gt;buffer-&gt;data + ALIGN(tr-&gt;data_size, sizeof(<span class="keyword">void</span> *)));</div><div class="line"></div><div class="line">    <span class="comment">// 从用户空间拷贝数据到 binder_buffer</span></div><div class="line">    <span class="keyword">if</span> (copy_from_user(t-&gt;buffer-&gt;data, tr-&gt;data.ptr.buffer, tr-&gt;data_size)) &#123;</div><div class="line">        return_error = BR_FAILED_REPLY;</div><div class="line">        goto err_copy_data_failed;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (copy_from_user(offp, tr-&gt;data.ptr.offsets, tr-&gt;offsets_size)) &#123;</div><div class="line">        return_error = BR_FAILED_REPLY;</div><div class="line">        goto err_copy_data_failed;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    off_end = (<span class="keyword">void</span> *)offp + tr-&gt;offsets_size;</div><div class="line">    <span class="keyword">for</span> (; offp &lt; off_end; offp++) &#123;</div><div class="line">        struct flat_binder_object *fp;</div><div class="line">        <span class="comment">// 为 flat_binder_object 赋值</span></div><div class="line">        fp = (struct flat_binder_object *)(t-&gt;buffer-&gt;data + *offp);</div><div class="line">        <span class="comment">// 转换 binder 类型，如果是 BINDER 则转换为 HANDLE， 如果是 HANDLE 则转为 BANDLE</span></div><div class="line">        <span class="keyword">switch</span> (fp-&gt;type) &#123;</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_BINDER:</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_BINDER: &#123;</div><div class="line">            struct binder_ref *ref;</div><div class="line">            <span class="comment">// 获取 binder_node 节点</span></div><div class="line">            struct binder_node *node = binder_get_node(proc, fp-&gt;binder);</div><div class="line">            <span class="keyword">if</span> (node == NULL) &#123;</div><div class="line">                node = binder_new_node(proc, fp-&gt;binder, fp-&gt;cookie);</div><div class="line">                <span class="keyword">if</span> (node == NULL) &#123;</div><div class="line">                    return_error = BR_FAILED_REPLY;</div><div class="line">                    goto err_binder_new_node_failed;</div><div class="line">                &#125;</div><div class="line">                node-&gt;min_priority = fp-&gt;flags &amp; FLAT_BINDER_FLAG_PRIORITY_MASK;</div><div class="line">                node-&gt;accept_fds = !!(fp-&gt;flags &amp; FLAT_BINDER_FLAG_ACCEPTS_FDS);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (fp-&gt;cookie != node-&gt;cookie) &#123;</div><div class="line">                goto err_binder_get_ref_for_node_failed;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 获取 binder_ref 对象</span></div><div class="line">            ref = binder_get_ref_for_node(target_proc, node);</div><div class="line">            <span class="comment">// 转换类型</span></div><div class="line">            <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_BINDER)</div><div class="line">                fp-&gt;type = BINDER_TYPE_HANDLE;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                fp-&gt;type = BINDER_TYPE_WEAK_HANDLE;</div><div class="line">            fp-&gt;handle = ref-&gt;desc;</div><div class="line">            binder_inc_ref(ref, fp-&gt;type == BINDER_TYPE_HANDLE,</div><div class="line">                       &amp;thread-&gt;todo);</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_HANDLE:</div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_WEAK_HANDLE: &#123;</div><div class="line">            <span class="comment">// 获取 binder_ref 对象</span></div><div class="line">            struct binder_ref*ref = binder_get_ref(proc, fp-&gt;handle);</div><div class="line">            <span class="comment">// 转换类型</span></div><div class="line">            <span class="keyword">if</span> (ref-&gt;node-&gt;proc == target_proc) &#123;</div><div class="line">                <span class="keyword">if</span> (fp-&gt;type == BINDER_TYPE_HANDLE)</div><div class="line">                    fp-&gt;type = BINDER_TYPE_BINDER;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    fp-&gt;type = BINDER_TYPE_WEAK_BINDER;</div><div class="line">                fp-&gt;binder = ref-&gt;node-&gt;ptr;</div><div class="line">                fp-&gt;cookie = ref-&gt;node-&gt;cookie;</div><div class="line">                binder_inc_node(ref-&gt;node, fp-&gt;type == BINDER_TYPE_BINDER, <span class="number">0</span>, NULL);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                struct binder_ref *new_ref;</div><div class="line">                new_ref = binder_get_ref_for_node(target_proc, ref-&gt;node);</div><div class="line">                fp-&gt;handle = new_ref-&gt;desc;</div><div class="line">                binder_inc_ref(new_ref, fp-&gt;type == BINDER_TYPE_HANDLE, NULL);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="comment">// 文件类型</span></div><div class="line">        <span class="keyword">case</span> BINDER_TYPE_FD: &#123;</div><div class="line">            <span class="keyword">int</span> target_fd;</div><div class="line">            struct file *file;</div><div class="line">            <span class="comment">// 获得文件对象</span></div><div class="line">            file = fget(fp-&gt;handle);</div><div class="line">            <span class="comment">// 分配一个新的文件描述符</span></div><div class="line">            target_fd = task_get_unused_fd_flags(target_proc, O_CLOEXEC);</div><div class="line">            task_fd_install(target_proc, target_fd, file);</div><div class="line">            fp-&gt;handle = target_fd;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            return_error = BR_FAILED_REPLY;</div><div class="line">            goto err_bad_object_type;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (reply) &#123;</div><div class="line">        <span class="comment">// BC_REPLY 处理流程, binder_transaction 中释放 binder_transaction 对象</span></div><div class="line">        binder_pop_transaction(target_thread, in_reply_to);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</div><div class="line">        <span class="comment">// 同步状态(双向)需要设置回复</span></div><div class="line">        t-&gt;need_reply = <span class="number">1</span>;</div><div class="line">        t-&gt;from_parent = thread-&gt;transaction_stack;</div><div class="line">        thread-&gt;transaction_stack = t;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 异步传输不需要设置回复</span></div><div class="line">        <span class="keyword">if</span> (target_node-&gt;has_async_transaction) &#123;</div><div class="line">            target_list = &amp;target_node-&gt;async_todo;</div><div class="line">            target_wait = NULL;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            target_node-&gt;has_async_transaction = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    t-&gt;work.type = BINDER_WORK_TRANSACTION;</div><div class="line">    list_add_tail(&amp;t-&gt;work.entry, target_list);</div><div class="line">    tcomplete-&gt;type = BINDER_WORK_TRANSACTION_COMPLETE;</div><div class="line">    list_add_tail(&amp;tcomplete-&gt;entry, &amp;thread-&gt;todo);</div><div class="line">    <span class="keyword">if</span> (target_wait)</div><div class="line">        <span class="comment">// 唤醒目标线程</span></div><div class="line">        wake_up_interruptible(target_wait);</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line">数据读取 - binder_thread_read() 函数</div><div class="line"></div><div class="line">用户空间从 binder 驱动读取数据，从驱动角度来看是写出的操作。</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></div><div class="line">                  struct binder_thread *thread,</div><div class="line">                  <span class="keyword">void</span>  __user *buffer, <span class="keyword">int</span> size,</div><div class="line">                  signed <span class="keyword">long</span> *consumed, <span class="keyword">int</span> non_block)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">void</span> __user *ptr = buffer + *consumed;</div><div class="line">    <span class="keyword">void</span> __user *end = buffer + size;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> wait_for_proc_work;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (*consumed == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 第一次操作时向用户空间返回 BR_NOOP 命令</span></div><div class="line">        <span class="keyword">if</span> (put_user(BR_NOOP, (uint32_t __user *)ptr))</div><div class="line">            <span class="keyword">return</span> -EFAULT;</div><div class="line">        ptr += sizeof(uint32_t);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">retry:</div><div class="line">    <span class="comment">// 获取将要处理的任务</span></div><div class="line">    wait_for_proc_work = thread-&gt;transaction_stack == NULL &amp;&amp;</div><div class="line">                list_empty(&amp;thread-&gt;todo);</div><div class="line">    <span class="keyword">if</span> (wait_for_proc_work) &#123;</div><div class="line">        <span class="keyword">if</span> (!(thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED |</div><div class="line">                    BINDER_LOOPER_STATE_ENTERED))) &#123;</div><div class="line">            binder_user_error(<span class="string">"binder: %d:%d ERROR: Thread waiting "</span></div><div class="line">                <span class="string">"for process work before calling BC_REGISTER_"</span></div><div class="line">                <span class="string">"LOOPER or BC_ENTER_LOOPER (state %x)\n"</span>,</div><div class="line">                proc-&gt;pid, thread-&gt;pid, thread-&gt;looper);</div><div class="line">            wait_event_interruptible(binder_user_error_wait,</div><div class="line">                         binder_stop_on_user_error &lt; <span class="number">2</span>);</div><div class="line">        &#125;</div><div class="line">        binder_set_nice(proc-&gt;default_priority);</div><div class="line">        <span class="keyword">if</span> (non_block) &#123;</div><div class="line">            <span class="comment">// 非阻塞且没有数据则返回 EAGAIN</span></div><div class="line">            <span class="keyword">if</span> (!binder_has_proc_work(proc, thread))</div><div class="line">                ret = -EAGAIN;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            <span class="comment">// 阻塞则进入睡眠状态，等待可操作的任务</span></div><div class="line">            ret = wait_event_freezable_exclusive(proc-&gt;wait, binder_has_proc_work(proc, thread));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (non_block) &#123;</div><div class="line">            <span class="keyword">if</span> (!binder_has_thread_work(thread))</div><div class="line">                ret = -EAGAIN;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">            ret = wait_event_freezable(thread-&gt;wait, binder_has_thread_work(thread));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    binder_lock(__func__);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (wait_for_proc_work)</div><div class="line">        proc-&gt;ready_threads--;</div><div class="line">    thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_WAITING;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ret)</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        uint32_t cmd;</div><div class="line">        struct binder_transaction_data tr;</div><div class="line">        struct binder_work *w;</div><div class="line">        struct binder_transaction *t = NULL;</div><div class="line"></div><div class="line">        <span class="comment">// 获取 binder_work 对象</span></div><div class="line">        <span class="keyword">if</span> (!list_empty(&amp;thread-&gt;todo))</div><div class="line">            w = list_first_entry(&amp;thread-&gt;todo, struct binder_work, entry);</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!list_empty(&amp;proc-&gt;todo) &amp;&amp; wait_for_proc_work)</div><div class="line">            w = list_first_entry(&amp;proc-&gt;todo, struct binder_work, entry);</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (ptr - buffer == <span class="number">4</span> &amp;&amp; !(thread-&gt;looper &amp; BINDER_LOOPER_STATE_NEED_RETURN)) <span class="comment">/* no data added */</span></div><div class="line">                goto retry;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (end - ptr &lt; sizeof(tr) + <span class="number">4</span>)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_TRANSACTION: &#123;</div><div class="line">            <span class="comment">// 获取 binder_transaction 对象</span></div><div class="line">            t = container_of(w, struct binder_transaction, work);</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_TRANSACTION_COMPLETE: &#123;</div><div class="line">            cmd = BR_TRANSACTION_COMPLETE;</div><div class="line">            <span class="comment">// 返回 BR_TRANSACTION_COMPLETE 命令</span></div><div class="line">            <span class="keyword">if</span> (put_user(cmd, (uint32_t __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(uint32_t);</div><div class="line"></div><div class="line">            binder_stat_br(proc, thread, cmd);</div><div class="line"></div><div class="line">            <span class="comment">// 从 work 链表中删除并释放内存</span></div><div class="line">            list_del(&amp;w-&gt;entry);</div><div class="line">            kfree(w);</div><div class="line">            binder_stats_deleted(BINDER_STAT_TRANSACTION_COMPLETE);</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_NODE: &#123;</div><div class="line">            <span class="comment">// 获得 binder_node 节点</span></div><div class="line">            struct binder_node *node = container_of(w, struct binder_node, work);</div><div class="line">            uint32_t cmd = BR_NOOP;</div><div class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *cmd_name;</div><div class="line">            <span class="comment">// 根据节点类型，增加/获取、减少/释放节点索引</span></div><div class="line">            <span class="keyword">int</span> strong = node-&gt;internal_strong_refs || node-&gt;local_strong_refs;</div><div class="line">            <span class="keyword">int</span> weak = !hlist_empty(&amp;node-&gt;refs) || node-&gt;local_weak_refs || strong;</div><div class="line">            <span class="comment">// 构造 BR_* 命令</span></div><div class="line">            <span class="keyword">if</span> (weak &amp;&amp; !node-&gt;has_weak_ref) &#123;</div><div class="line">                cmd = BR_INCREFS;</div><div class="line">                cmd_name = <span class="string">"BR_INCREFS"</span>;</div><div class="line">                node-&gt;has_weak_ref = <span class="number">1</span>;</div><div class="line">                node-&gt;pending_weak_ref = <span class="number">1</span>;</div><div class="line">                node-&gt;local_weak_refs++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strong &amp;&amp; !node-&gt;has_strong_ref) &#123;</div><div class="line">                cmd = BR_ACQUIRE;</div><div class="line">                cmd_name = <span class="string">"BR_ACQUIRE"</span>;</div><div class="line">                node-&gt;has_strong_ref = <span class="number">1</span>;</div><div class="line">                node-&gt;pending_strong_ref = <span class="number">1</span>;</div><div class="line">                node-&gt;local_strong_refs++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strong &amp;&amp; node-&gt;has_strong_ref) &#123;</div><div class="line">                cmd = BR_RELEASE;</div><div class="line">                cmd_name = <span class="string">"BR_RELEASE"</span>;</div><div class="line">                node-&gt;has_strong_ref = <span class="number">0</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!weak &amp;&amp; node-&gt;has_weak_ref) &#123;</div><div class="line">                cmd = BR_DECREFS;</div><div class="line">                cmd_name = <span class="string">"BR_DECREFS"</span>;</div><div class="line">                node-&gt;has_weak_ref = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 向用户空间返回命令</span></div><div class="line">            <span class="keyword">if</span> (cmd != BR_NOOP) &#123;</div><div class="line">                <span class="keyword">if</span> (put_user(cmd, (uint32_t __user *)ptr))</div><div class="line">                    <span class="keyword">return</span> -EFAULT;</div><div class="line">                ptr += sizeof(uint32_t);</div><div class="line">                <span class="keyword">if</span> (put_user(node-&gt;ptr, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                    <span class="keyword">return</span> -EFAULT;</div><div class="line">                ptr += sizeof(<span class="keyword">void</span> *);</div><div class="line">                <span class="keyword">if</span> (put_user(node-&gt;cookie, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                    <span class="keyword">return</span> -EFAULT;</div><div class="line">                ptr += sizeof(<span class="keyword">void</span> *);</div><div class="line"></div><div class="line">                binder_stat_br(proc, thread, cmd);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                list_del_init(&amp;w-&gt;entry);</div><div class="line">                <span class="keyword">if</span> (!weak &amp;&amp; !strong) &#123;</div><div class="line">                    rb_erase(&amp;node-&gt;rb_node, &amp;proc-&gt;nodes);</div><div class="line">                    kfree(node);</div><div class="line">                    binder_stats_deleted(BINDER_STAT_NODE);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER:</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER_AND_CLEAR:</div><div class="line">        <span class="keyword">case</span> BINDER_WORK_CLEAR_DEATH_NOTIFICATION: &#123;</div><div class="line">            struct binder_ref_death *death;</div><div class="line">            uint32_t cmd;</div><div class="line"></div><div class="line">            <span class="comment">// 获取 binder_ref_death 对象</span></div><div class="line">            death = container_of(w, struct binder_ref_death, work);</div><div class="line">            <span class="comment">// 构造返回命令</span></div><div class="line">            <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION)</div><div class="line">                cmd = BR_CLEAR_DEATH_NOTIFICATION_DONE;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                cmd = BR_DEAD_BINDER;</div><div class="line">            <span class="comment">// 向用户空间返回命令</span></div><div class="line">            <span class="keyword">if</span> (put_user(cmd, (uint32_t __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(uint32_t);</div><div class="line">            <span class="comment">// 将 cookie 返回给用户空间</span></div><div class="line">            <span class="keyword">if</span> (put_user(death-&gt;cookie, (<span class="keyword">void</span> * __user *)ptr))</div><div class="line">                <span class="keyword">return</span> -EFAULT;</div><div class="line">            ptr += sizeof(<span class="keyword">void</span> *);</div><div class="line">            binder_stat_br(proc, thread, cmd);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION) &#123;</div><div class="line">                list_del(&amp;w-&gt;entry);</div><div class="line">                kfree(death);</div><div class="line">                binder_stats_deleted(BINDER_STAT_DEATH);</div><div class="line">            &#125; <span class="keyword">else</span></div><div class="line">                list_move(&amp;w-&gt;entry, &amp;proc-&gt;delivered_death);</div><div class="line">            <span class="keyword">if</span> (cmd == BR_DEAD_BINDER)</div><div class="line">                goto done; <span class="comment">/* DEAD_BINDER notifications can cause transactions */</span></div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!t)</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (t-&gt;buffer-&gt;target_node) &#123;</div><div class="line">            <span class="comment">// 获得 binder_node 节点</span></div><div class="line">            struct binder_node *target_node = t-&gt;buffer-&gt;target_node;</div><div class="line">            <span class="comment">// 将数据封装到 binder_transaction_data 对象</span></div><div class="line">            tr.target.ptr = target_node-&gt;ptr;</div><div class="line">            tr.cookie =  target_node-&gt;cookie;</div><div class="line">            t-&gt;saved_priority = task_nice(current);</div><div class="line">            <span class="keyword">if</span> (t-&gt;priority &lt; target_node-&gt;min_priority &amp;&amp;</div><div class="line">                !(t-&gt;flags &amp; TF_ONE_WAY))</div><div class="line">                binder_set_nice(t-&gt;priority);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!(t-&gt;flags &amp; TF_ONE_WAY) ||</div><div class="line">                 t-&gt;saved_priority &gt; target_node-&gt;min_priority)</div><div class="line">                binder_set_nice(target_node-&gt;min_priority);</div><div class="line">            <span class="comment">// 设置返回的命令类型</span></div><div class="line">            cmd = BR_TRANSACTION;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            tr.target.ptr = NULL;</div><div class="line">            tr.cookie = NULL;</div><div class="line">            cmd = BR_REPLY;</div><div class="line">        &#125;</div><div class="line">        tr.code = t-&gt;code;</div><div class="line">        tr.flags = t-&gt;flags;</div><div class="line">        tr.sender_euid = t-&gt;sender_euid;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (t-&gt;from) &#123;</div><div class="line">            struct task_struct *sender = t-&gt;from-&gt;proc-&gt;tsk;</div><div class="line">            tr.sender_pid = task_tgid_nr_ns(sender,</div><div class="line">                            current-&gt;nsproxy-&gt;pid_ns);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            tr.sender_pid = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tr.data_size = t-&gt;buffer-&gt;data_size;</div><div class="line">        tr.offsets_size = t-&gt;buffer-&gt;offsets_size;</div><div class="line">        tr.data.ptr.buffer = (<span class="keyword">void</span> *)t-&gt;buffer-&gt;data +</div><div class="line">                    proc-&gt;user_buffer_offset;</div><div class="line">        tr.data.ptr.offsets = tr.data.ptr.buffer +</div><div class="line">                    ALIGN(t-&gt;buffer-&gt;data_size,</div><div class="line">                        sizeof(<span class="keyword">void</span> *));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (put_user(cmd, (uint32_t __user *)ptr))</div><div class="line">            <span class="keyword">return</span> -EFAULT;</div><div class="line">        ptr += sizeof(uint32_t);</div><div class="line">        <span class="comment">// 拷贝 binder_transaction_data 对象到用户空间</span></div><div class="line">        <span class="keyword">if</span> (copy_to_user(ptr, &amp;tr, sizeof(tr)))</div><div class="line">            <span class="keyword">return</span> -EFAULT;</div><div class="line">        ptr += sizeof(tr);</div><div class="line"></div><div class="line">        binder_stat_br(proc, thread, cmd);</div><div class="line"></div><div class="line">        <span class="comment">// 移除 binder_transaction 并释放空间</span></div><div class="line">        list_del(&amp;t-&gt;work.entry);</div><div class="line">        t-&gt;buffer-&gt;allow_user_free = <span class="number">1</span>;</div><div class="line">        <span class="comment">// 如果是同步操作，则将 thread 对象保存在 binder_transaction 中，返回给发送方进程, 否则释放 binder_transaction 对象</span></div><div class="line">        <span class="keyword">if</span> (cmd == BR_TRANSACTION &amp;&amp; !(t-&gt;flags &amp; TF_ONE_WAY)) &#123;</div><div class="line">            t-&gt;to_parent = thread-&gt;transaction_stack;</div><div class="line">            t-&gt;to_thread = thread;</div><div class="line">            thread-&gt;transaction_stack = t;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            t-&gt;buffer-&gt;transaction = NULL;</div><div class="line">            kfree(t);</div><div class="line">            binder_stats_deleted(BINDER_STAT_TRANSACTION);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上述代码可以看出 binder 驱动的具体实现，以及是如何发送和接收数据的。</p>
<h2 id="5-Binder-与系统服务"><a href="#5-Binder-与系统服务" class="headerlink" title="5. Binder 与系统服务"></a>5. Binder 与系统服务</h2><h3 id="5-1-Context-getSystemService"><a href="#5-1-Context-getSystemService" class="headerlink" title="5.1 Context.getSystemService()"></a>5.1 Context.getSystemService()</h3><p>Android 系统在启动后会在后台运行很多系统服务提供给应用使用，这些 <code>服务</code> 主要有 <code>WindowManager</code>, <code>LayoutInflater</code>, <code>ActivityManager</code>, <code>PowerManager</code>, <code>AlarmManager</code>, <code>NotificationManager</code>, <code>KeyguardManager</code>, <code>LocationManager</code>, <code>SearchManager</code>, <code>Vibrator</code>, <code>ConnectivityManager</code>, <code>WifiManager</code>, <code>AudioManager</code>, <code>MediaRouter</code>, <code>TelephonyManager</code>, <code>SubscriptionManager</code>, <code>InputMethodManager</code>, <code>UiModeManager</code>, <code>DownloadManager</code>, <code>BatteryManager</code>, <code>JobScheduler</code>, <code>NetworkStatsManager</code></p>
<p>我们可以通过 <code>Context.getSystemService(String name)</code> 来获取 <code>服务</code>。</p>
<p>例如 可以通过如下方法从 xml 中插入新的视图</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LayoutInflater inflater = (LayoutInflater) getSystemService(LAYOUT_INFLATER_SERVICE);</div><div class="line">inflater.inflate(R.layout.view, root, <span class="keyword">true</span>);</div></pre></td></tr></table></figure>
<h3 id="5-2-Context-getSystemService-源码分析"><a href="#5-2-Context-getSystemService-源码分析" class="headerlink" title="5.2 Context.getSystemService() 源码分析"></a>5.2 Context.getSystemService() 源码分析</h3><p>追踪 <code>ContextImpl</code> <code>getSystemService()</code> 源代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> SystemServiceRegistry.getSystemService(<span class="keyword">this</span>, name);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>继续追踪 <code>SystemServiceRegistry</code> 源代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">   * Gets a system service from a given context.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getSystemService</span><span class="params">(ContextImpl ctx, String name)</span> </span>&#123;</div><div class="line">      ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</div><div class="line">      <span class="keyword">return</span> fetcher != <span class="keyword">null</span> ? fetcher.getService(ctx) : <span class="keyword">null</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>追踪 <code>SYSTEM_SERVICE_FETCHERS</code> 可以发现在 <code>SystemServiceRegistry</code> 静态区中注册了几乎所有的系统服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,</div><div class="line">           <span class="keyword">new</span> CachedServiceFetcher&lt;LayoutInflater&gt;() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> LayoutInflater <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> PhoneLayoutInflater(ctx.getOuterContext());</div><div class="line">       &#125;&#125;);</div><div class="line"></div><div class="line">   registerService(Context.LOCATION_SERVICE, LocationManager.class,</div><div class="line">           <span class="keyword">new</span> CachedServiceFetcher&lt;LocationManager&gt;() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> LocationManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">           IBinder b = ServiceManager.getService(Context.LOCATION_SERVICE);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">new</span> LocationManager(ctx, ILocationManager.Stub.asInterface(b));</div><div class="line">       &#125;&#125;);</div></pre></td></tr></table></figure>
<p>上面代码片断中，<code>PhoneLayoutInflater</code> 最终回到了 <code>LayoutInflater</code>。而 <code>LocationManager</code> 则是对 <code>ILocationManager</code> 的封装。可以发现，在 <code>frameworks/base/location/java/android/location</code> 包下含有大量的 AIDL 文件。</p>
<p>继续追踪 <code>ServiceManager.getService(Context.LOCATION_SERVICE)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (sServiceManager != <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">return</span> sServiceManager;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Find the service manager</span></div><div class="line">     sServiceManager = ServiceManagerNative.asInterface(BinderInternal.getContextObject());</div><div class="line">     <span class="keyword">return</span> sServiceManager;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * Returns a reference to a service with the given name.</div><div class="line">  * </div><div class="line">  * <span class="doctag">@param</span> name the name of the service to get</div><div class="line">  * <span class="doctag">@return</span> a reference to the service, or &lt;code&gt;null&lt;/code&gt; if the service doesn't exist</div><div class="line">  */</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         IBinder service = sCache.get(name);</div><div class="line">         <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">return</span> service;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             <span class="keyword">return</span> getIServiceManager().getService(name);</div><div class="line">         &#125;</div><div class="line">     &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">         Log.e(TAG, <span class="string">"error in getService"</span>, e);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>从上面代码片断可以看出，<code>ServiceManager</code> 会从 <code>sCache</code> 缓存或 <code>IServiceManager</code> 中查找服务并返回一个 <code>IBinder</code> 对象。这个 <code>IBinder</code> 就是一个远程对象，可以通过它与其他进程交互。</p>
<p>继续深入 <code>getIServiceManager().getService(name)</code> , 进入 <code>ServiceManagerNative</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Cast a Binder object into a service manager interface, generating</div><div class="line">     * a proxy if needed.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        IServiceManager in =</div><div class="line">            (IServiceManager)obj.queryLocalInterface(descriptor);</div><div class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> in;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceManagerProxy(obj);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title">IServiceManager</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> </span>&#123;</div><div class="line">            mRemote = remote;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mRemote;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            Parcel data = Parcel.obtain();</div><div class="line">            Parcel reply = Parcel.obtain();</div><div class="line">            data.writeInterfaceToken(IServiceManager.descriptor);</div><div class="line">            data.writeString(name);</div><div class="line">            mRemote.transact(GET_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">            IBinder binder = reply.readStrongBinder();</div><div class="line">            reply.recycle();</div><div class="line">            data.recycle();</div><div class="line">            <span class="keyword">return</span> binder;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> IBinder mRemote;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上边代码片断可以看到，<code>ServiceManager.getIServiceManager()</code> 返回的是一个 <code>ServiceManagerProxy</code>, 而 <code>ServiceManager.getService()</code> 则是在 <code>ServiceManagerProxy</code> 中通过 <code>ServiceManager</code> 的远程 Binder 对象 <code>mRemote</code>，操作 Parcel 数据，调用 <code>IBinder.transact(int code, Parcel data, Parcel reply, int flags)</code>方法来发送请求，并通过 <code>reply.readStrongBinder()</code> 返回了要查找的服务的远程对象。</p>
<p>可以看到，系统服务的获取方式也是通过 AIDL 的方式实现的。</p>
<h2 id="6-结论"><a href="#6-结论" class="headerlink" title="6. 结论"></a>6. 结论</h2><ol>
<li><p>Binder 的实现涉及到 kernel 驱动，本地层，JNI 和应用层，贯穿了整个 Ａndroid 系统。系统服务获取、Activity/Service 启动、Intent的传递等都离不开 binder,要掌握 binder 的原理需要深入到系统的每一层代码。</p>
</li>
<li><p>上层的<code>android.os.Binder</code> 只是对 binder 的又一次抽象封装，我们在应用中一般也不会直接使用。</p>
</li>
<li><p>AIDL 本质上是一个用于封装 Binder 操作的工具，最终的进程间通信由 Binder 的 <code>transact</code> 和 <code>onTransact</code> 完成。我们在应用中实现 AIDL 接口，可以快速实现进程间通信.</p>
</li>
</ol>
<h2 id="7-参考"><a href="#7-参考" class="headerlink" title="7.参考"></a>7.参考</h2><p>Android Binder机制</p>
<p>Android进程间通信（IPC）机制Binder</p>
<p>Android Binder</p>
<p>Android Architecture Binder</p>
<p>AIDL与Binder框架浅谈</p>
<p>Binder框架解析</p>
<p>Deep Dive into Android IPC/Binder Framework at Android Builders Summit 2013</p>
<p>Android Builders Summit 2013 - Deep Dive into Android IPC/Binder Framework (video)</p>
<p>Binder源码分析之驱动层（原）</p>
<p>深入分析Android Binder 驱动</p>
<p>构造IOCTL命令的学习心得—–_IO, _IOR, _IOW, _IOWR 幻数的理解</p>
<p>Service与Android系统设计（7）— Binder驱动</p>
<p>Android Binder</p>
<p>Binder机制，从Java到C （7. Native Service）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/06/26/Binder源码分析/" data-id="cixbj8xmk002644tfdjs0usfw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AIDL/">AIDL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Binder/">Binder</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/5-0新特性/">5.0新特性</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android优化/">Android优化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android更新/">Android更新</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android消息机制/">Android消息机制</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/主题切换/">主题切换</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/图片加载框架/">图片加载框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/屏幕适配/">屏幕适配</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/更换头像/">更换头像</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/源码分析/">源码分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/第三方UI库/">第三方UI库</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/supports-screens/"><supports-screens></a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIDL/">AIDL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Binder/">Binder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fresco/">Fresco</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Glide/">Glide</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Handler/">Handler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Looper/">Looper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PagerSlidingTabStrip/">PagerSlidingTabStrip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Picasso/">Picasso</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RecyclerView/">RecyclerView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UniversalImageLoader/">UniversalImageLoader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-API/">android API</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/主题/">主题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/主题切换/">主题切换</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/增量更新/">增量更新</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/头像/">头像</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/屏幕适配/">屏幕适配</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能/">性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息机制/">消息机制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/热修复/">热修复</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组件化/">组件化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/supports-screens/" style="font-size: 10px;"><supports-screens></a> <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Binder/" style="font-size: 10px;">Binder</a> <a href="/tags/Fresco/" style="font-size: 10px;">Fresco</a> <a href="/tags/Glide/" style="font-size: 10px;">Glide</a> <a href="/tags/Handler/" style="font-size: 10px;">Handler</a> <a href="/tags/Looper/" style="font-size: 10px;">Looper</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/PagerSlidingTabStrip/" style="font-size: 10px;">PagerSlidingTabStrip</a> <a href="/tags/Picasso/" style="font-size: 10px;">Picasso</a> <a href="/tags/RecyclerView/" style="font-size: 10px;">RecyclerView</a> <a href="/tags/UniversalImageLoader/" style="font-size: 10px;">UniversalImageLoader</a> <a href="/tags/android-API/" style="font-size: 10px;">android API</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/主题/" style="font-size: 10px;">主题</a> <a href="/tags/主题切换/" style="font-size: 10px;">主题切换</a> <a href="/tags/增量更新/" style="font-size: 10px;">增量更新</a> <a href="/tags/头像/" style="font-size: 10px;">头像</a> <a href="/tags/屏幕适配/" style="font-size: 10px;">屏幕适配</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/消息机制/" style="font-size: 10px;">消息机制</a> <a href="/tags/热修复/" style="font-size: 10px;">热修复</a> <a href="/tags/组件化/" style="font-size: 10px;">组件化</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/30/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2016/12/23/主题切换实现/">Android主题切换实现</a>
          </li>
        
          <li>
            <a href="/2016/12/23/模板/">(no title)</a>
          </li>
        
          <li>
            <a href="/2016/12/22/supports-screens使用/">supports-screens使用</a>
          </li>
        
          <li>
            <a href="/2016/07/29/APP更换头像实现/">APP更换头像实现</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>